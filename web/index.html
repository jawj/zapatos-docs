<!DOCTYPE html><html lang="en"><head>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta name="google-site-verification" content="tN1ANkxDkpFanVNXNfGs0pOFnDVAZH6tkBCRW2fkV8I">
        <!-- tocbot -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">
        <!-- highlighting -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/xcode.min.css">
        <!-- monaco editor -->
        <script src="monaco/vs/loader.js"></script>
        <script src="zapatos-bundle.js"></script>
        <!-- fonts -->
        <link rel="stylesheet" href="https://use.typekit.net/mdb7zvi.css">
        <!-- octocat -->
        <style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
        <!-- custom -->
        <link rel="stylesheet" href="docs.css">
      <title>Zapatos: Zero-Abstraction Postgres for TypeScript</title></head>
      <body>
        <!-- http://tholman.com/github-corners/ -->
        <a href="https://github.com/jawj/zapatos" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#aaa; color:#fff; position: fixed; z-index: 150; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
      
        <div id="toc"></div>
        <div id="content"><div class="logos"><img class="pg-logo" src="pg.svg" width="43.2" height="44.5" alt="Postgres logo"><img class="ts-logo" src="ts.svg" width="50.5" height="39" alt="TypeScript logo"></div>
<h1 id="zapatos-zero-abstraction-postgres-for-typescript"><b>Zap<span class="extra-vowels a">a</span>t<span class="extra-vowels o">o</span>s:</b> <br><span style="font-weight: normal;">Zero-Abstraction Postgres for TypeScript</span></h1>
<p><a href="https://www.postgresql.org/">Postgres</a> and <a href="https://www.typescriptlang.org/">TypeScript</a> are each, individually, fabulous.</p>
<p>Zapatos aims to make them work beautifully together. No abstractions, no distractions: just your database, with type safety.</p>
<h2 id="what-does-it-do">What does it do?</h2>
<p>To achieve this aim, Zapatos does these five things:</p>
<ul>
<li>
<p><strong>Typescript schema</strong> &nbsp; A command-line tool speaks to your Postgres database and writes up a detailed TypeScript schema for every table. This is just a means to an end: it enables the next three things in this list. <a href="#typescript-schema">Show me »</a></p>
</li>
<li>
<p><strong>Arbitrary SQL</strong> &nbsp; Simple building blocks help you write arbitrary SQL using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#Tagged_templates">tagged templates</a>, and manually apply the right types to what goes in and what comes back. <a href="#arbitrary-sql">Show me »</a></p>
</li>
<li>
<p><strong>Everyday CRUD</strong> &nbsp; Shortcut functions produce everyday <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> queries with no fuss and no surprises, fully and automatically typed. <a href="#everyday-crud">Show me »</a></p>
</li>
<li>
<p><strong>JOINs as nested JSON</strong> &nbsp; Nested shortcut calls generate <a href="https://www.postgresql.org/docs/12/queries-table-expressions.html#id-1.5.6.6.5.10.2">LATERAL JOIN</a> queries, resulting in arbitrarily complex nested JSON structures, still fully and automatically typed. <a href="#joins-as-nested-json">Show me »</a></p>
</li>
<li>
<p><strong>Transactions</strong> &nbsp; A <code>transaction</code> function helps with managing and retrying transactions. <a href="#transactions">Show me »</a></p>
</li>
</ul>
<h3 id="how-does-that-look">How does that look?</h3>
<h4 id="typescript-schema">Typescript schema</h4>
<p><strong>A command-line tool speaks to your Postgres database and writes up a detailed TypeScript schema for every table.</strong></p>
<p>Take this ultra-simple SQL schema for a single table, <code>authors</code>:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"authors"</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"id"</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"name"</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"isLiving"</span> <span class="hljs-built_in">BOOLEAN</span> );</span></code></pre>
<p>We run <code>npx zapatos</code> to generate a file named <code>schema.ts</code>, including table definitions like this one:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> authors {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">/* ... */</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> Selectable {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    id: <span class="hljs-built_in">number</span>;</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    name: <span class="hljs-built_in">string</span>;</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    isLiving: <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">null</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  };</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> Insertable {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    id?: <span class="hljs-built_in">number</span> | DefaultType | SQLFragment;</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    name: <span class="hljs-built_in">string</span> | SQLFragment;</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    isLiving?: <span class="hljs-built_in">boolean</span> | <span class="hljs-literal">null</span> | DefaultType | SQLFragment;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  };</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> Updatable <span class="hljs-keyword">extends</span> Partial&lt;Insertable&gt; { };</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> Whereable = { [K <span class="hljs-keyword">in</span> keyof Insertable]?: </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    Exclude&lt;Insertable[K] | ParentColumn, <span class="hljs-literal">null</span> | DefaultType&gt; };</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">/* ... */</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>The types are, I hope, pretty self-explanatory. <code>authors.Selectable</code> is what I’ll get back from a <code>SELECT</code> query on this table. <code>authors.Insertable</code> is what I can <code>INSERT</code>: similar to the <code>Selectable</code>, but any fields that are <code>NULL</code>able and/or have <code>DEFAULT</code> values are allowed to be missing, <code>NULL</code> or <code>DEFAULT</code>. <code>authors.Updatable</code> is what I can <code>UPDATE</code> the table with: like what I can <code>INSERT</code>, but all columns are optional: it’s a simple <code>Partial&lt;authors.Insertable&gt;</code>. <code>authors.Whereable</code>, finally, is what I can use in a <code>WHERE</code> condition</p>
<p><code>schema.ts</code> includes a few other types that get used internally, including some handy type mappings, such as this one:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> SelectableForTable&lt;T <span class="hljs-keyword">extends</span> Table&gt; = {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  authors: authors.Selectable;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  books: books.Selectable;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  tags: tags.Selectable;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">/* ... */</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}[T];</span></code></pre>
<p><a href="#how-do-i-use-it">Tell me more about the command line tool »</a></p>
<h4 id="arbitrary-sql">Arbitrary SQL</h4>
<p><strong>Simple building blocks help you write arbitrary SQL using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#Tagged_templates">tagged templates</a>, and manually apply the right types to what goes in and what comes back.</strong></p>
<p>Let’s insert something into that <code>authors</code> table for which we just generated the types. We’ll write the SQL query ourselves, to show how that works (though we’ll see an easier way <a href="#everyday-crud">in the next section</a>):</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  author: s.authors.Insertable = {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    name: <span class="hljs-string">'Gabriel Garcia Marquez'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    isLiving: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  [insertedAuthor] = <span class="hljs-keyword">await</span> db.sql&lt;s.authors.SQL, s.authors.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string">      INSERT INTO <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span> (<span class="hljs-subst">${db.cols(author)}</span>)</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string">      VALUES (<span class="hljs-subst">${db.vals(author)}</span>) RETURNING *`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    .run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"authors"</span> (<span class="hljs-string">"isLiving"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> *</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-literal">false</span>, <span class="hljs-string">"Gabriel Garcia Marquez"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Gabriel Garcia Marquez"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>We apply the appropriate type to the object we’re trying to insert (<code>s.authors.Insertable</code>), giving us type-checking and autocompletion on that object. And we specify both which types are allowed as interpolated values in the template string (<code>s.authors.SQL</code>) and what type is going to be returned (<code>s.authors.Selectable[]</code>)&nbsp;when the query runs.</p>
<p>We also use the <a href="#cols-and-vals"><code>cols</code> and <code>vals</code> helper functions</a>. These compile, respectively, to the object’s keys (which are the column names) and query placeholders (<code>$1</code>, <code>$2</code>, …) for the corresponding values.</p>
<p><em>You can click ‘Explore types’ above to open the code in an embedded Monaco (VS Code) editor, so you can check those typings for yourself.</em></p>
<p><a href="#sql-tagged-template-strings">Tell me more about writing arbitrary SQL »</a></p>
<h4 id="everyday-crud">Everyday CRUD</h4>
<p><strong>Shortcut functions produce everyday <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> queries with no fuss and no surprises, fully and automatically typed.</strong></p>
<p>So —&nbsp;writing SQL with Zapatos is nicer than constructing a query and all its input and output types from scratch. But for a totally bog-standard CRUD query like the <code>INSERT</code> above, it still involves quite a lot of boilerplate.</p>
<p>To eliminate the boilerplate, Zapatos supplies some simple functions to generate these sorts of queries, fully and automatically typed.</p>
<p>Let’s use one of them — <code>insert</code> — to add two more authors:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [doug, janey] = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'authors'</span>, [</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Douglas Adams'</span>, isLiving: <span class="hljs-literal">false</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Jane Austen'</span>, isLiving: <span class="hljs-literal">false</span>},</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"authors"</span> (<span class="hljs-string">"isLiving"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>), ($<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-literal">false</span>, <span class="hljs-string">"Douglas Adams"</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">"Jane Austen"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Douglas Adams"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Jane Austen"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>The <code>insert</code> shortcut accepts a single <code>Insertable</code> or an <code>Insertable[]</code> array, and correspondingly returns a single <code>Selectable</code> or a <code>Selectable[]</code> array. Since we specified <code>'authors'</code> as the first argument here, and an array as the second, input and output will be checked and auto-completed as <code>authors.Insertable[]</code> and <code>authors.Selectable[]</code> respectively.</p>
<p><em>Again, click ‘Explore types’ to play around and check those typings.</em></p>
<p>In addition to <code>insert</code>, there are shortcuts for <code>select</code>, <code>selectOne</code> and <code>count</code>, and for <code>update</code>, <code>upsert</code>, <code>delete</code> and <code>truncate</code>.</p>
<p><a href="#shortcut-functions-and-lateral-joins">Tell me more about the shortcut functions »</a></p>
<h4 id="joins-as-nested-json">JOINs as nested JSON</h4>
<p><strong>Nested shortcut calls generate <a href="https://www.postgresql.org/docs/12/queries-table-expressions.html#id-1.5.6.6.5.10.2">LATERAL JOIN</a> queries, resulting in arbitrarily complex nested JSON structures, still fully and automatically typed.</strong></p>
<p>CRUD is our bread and butter, but the power of SQL is that it’s <em>relational</em> — it’s in the <code>JOIN</code>s. And Postgres has some powerful JSON features that can deliver us sensibly-structured <code>JOIN</code> results with minimal post-processing (that’s <code>json_agg</code>, <code>json_build_object</code>, and so on).</p>
<p>To demonstrate, let’s say that <code>authors</code> have <code>books</code> and <code>books</code> have <code>tags</code>, adding two new tables to our simple schema:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"books"</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"id"</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"authorId"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">"authors"</span>(<span class="hljs-string">"id"</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"title"</span> <span class="hljs-built_in">TEXT</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"createdAt"</span> TIMESTAMPTZ <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">now</span>() );</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"tags"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"tag"</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"bookId"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">"books"</span>(<span class="hljs-string">"id"</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span> );</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-string">"tagsUniqueIdx"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"tags"</span>(<span class="hljs-string">"tag"</span>, <span class="hljs-string">"bookId"</span>);</span></code></pre>
<p>Now, let’s say I want to show a list of books, each with its (one) author and (many) associated tags. We could knock up a manual query for this, of course, but <a href="#manual-joins-using-postgres-json-features">it gets quite hairy</a>. The <code>select</code> shortcut has an option called <code>lateral</code> that can nest other <code>select</code> queries and do it for us.</p>
<p>Let’s try it:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> bookAuthorTags = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, db.all, {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateral: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    author: db.selectOne(<span class="hljs-string">'authors'</span>, { id: db.parent(<span class="hljs-string">'authorId'</span>) }),</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    tags: db.select(<span class="hljs-string">'tags'</span>, { bookId: db.parent(<span class="hljs-string">'id'</span>) }),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) || jsonb_build_object($<span class="hljs-number">1</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_0"</span>.result, $<span class="hljs-number">2</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_1"</span>.result) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = <span class="hljs-string">"books"</span>.<span class="hljs-string">"authorId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">3</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_0"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"tags"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">FROM</span> <span class="hljs-string">"tags"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"bookId"</span> = <span class="hljs-string">"books"</span>.<span class="hljs-string">"id"</span>)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_tags"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_1"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"author"</span>, <span class="hljs-string">"tags"</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1000</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"1/3"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1000</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1001</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"2/3"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1001</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1002</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"3/3"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1002</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"mystery"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1003</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1004</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"adventure"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1004</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Holes"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Louis Sachar"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.977396+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>This generates an efficient three-table <code>LATERAL JOIN</code> that returns a nested JSON structure directly from the database. Every nested element is again fully and automatically typed.</p>
<p><em>Again, you can click ‘Explore types’ above to open the code in an embedded Monaco (VS Code) editor, so you can check those typings for yourself.</em></p>
<p>We can of course extend this to deeper nesting (e.g. query each author, with their books, with their tags); to self-joins (of a table with itself, e.g. employees to their managers in the same <code>employees</code> table); and to joins on relationships other than foreign keys (e.g. joining the nearest <em>N</em> somethings using the PostGIS <code>&lt;-&gt;</code> distance operator).</p>
<p><a href="#lateral-and-alias">Tell me more about nested <code>select</code> queries »</a></p>
<h4 id="transactions">Transactions</h4>
<p><strong>A <code>transaction</code> function helps with managing and retrying transactions.</strong></p>
<p>Transactions are where I’ve found traditional ORMs like TypeORM and Sequelize probably most footgun-prone. Zapatos is always explicit about what client or pool is running your query —&nbsp;hence the <code>pool</code> argument in all our examples so far.</p>
<p>Zapatos also offers a simple <code>transaction</code> helper function that handles issuing a SQL <code>ROLLBACK</code> on error, releasing the database client in a TypeScript <code>finally</code> clause (i.e. whether or not an error was thrown), and automatically retrying queries in case of serialization failures. It looks like this:</p>
<pre class="language-typescript noresult runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> db.transaction(pool, db.Isolation.Serializable, <span class="hljs-keyword">async</span> txnClient =&gt; {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">/* queries here use txnClient instead of pool */</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">});</span></code></pre>
<p>For example, take this <code>bankAccounts</code> table:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"bankAccounts"</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"id"</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"balance"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">CHECK</span> (<span class="hljs-string">"balance"</span> &gt; <span class="hljs-number">0</span>) );</span></code></pre>
<p>We can use the <code>transaction</code> helper like so:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [accountA, accountB] = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'bankAccounts'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  [{ balance: <span class="hljs-number">50</span> }, { balance: <span class="hljs-number">50</span> }]).run(pool);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> transferMoney = <span class="hljs-function">(<span class="hljs-params">sendingAccountId: <span class="hljs-built_in">number</span>, receivingAccountId: <span class="hljs-built_in">number</span>, amount: <span class="hljs-built_in">number</span></span>) =&gt;</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  db.transaction(pool, db.Isolation.Serializable, <span class="hljs-function"><span class="hljs-params">txnClient</span> =&gt;</span> <span class="hljs-built_in">Promise</span>.all([</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    db.update(<span class="hljs-string">'bankAccounts'</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      { balance: db.sql&lt;db.SQL&gt;<span class="hljs-string">`<span class="hljs-subst">${db.self}</span> - <span class="hljs-subst">${db.param(amount)}</span>`</span> },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      { id: sendingAccountId }).run(txnClient),</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    db.update(<span class="hljs-string">'bankAccounts'</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      { balance: db.sql&lt;db.SQL&gt;<span class="hljs-string">`<span class="hljs-subst">${db.self}</span> + <span class="hljs-subst">${db.param(amount)}</span>`</span> },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      { id: receivingAccountId }).run(txnClient),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ]));</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">try</span> {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">const</span> [[updatedAccountA], [updatedAccountB]] = <span class="hljs-keyword">await</span> transferMoney(accountA.id, accountB.id, <span class="hljs-number">60</span>);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">} <span class="hljs-keyword">catch</span>(err) {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-built_in">console</span>.log(err.message, <span class="hljs-string">'/'</span>, err.detail);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"bankAccounts"</span> (<span class="hljs-string">"balance"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>), ($<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"bankAccounts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">50</span>, <span class="hljs-number">50</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"balance"</span>: <span class="hljs-number">50</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"balance"</span>: <span class="hljs-number">50</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">UPDATE</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">"bankAccounts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SET</span> (<span class="hljs-string">"balance"</span>) = <span class="hljs-keyword">ROW</span> (<span class="hljs-string">"balance"</span> - $<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"bankAccounts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">60</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">UPDATE</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">"bankAccounts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SET</span> (<span class="hljs-string">"balance"</span>) = <span class="hljs-keyword">ROW</span> (<span class="hljs-string">"balance"</span> + $<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"bankAccounts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">60</span>, <span class="hljs-number">2</span>]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">ROLLBACK</span></span></code></pre>
<pre class="console"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">new row for relation "bankAccounts" violates check constraint "bankAccounts_balance_check" / Failing row contains (1, -10).</span></code></pre>
</div>
<p>Finally, it provides a set of hierarchical isolation types so that, for example, if you type a <code>txnClient</code> argument to a function as <code>TxnSatisfying.RepeatableRead</code>, you can call it with <code>Isolation.Serializable</code> or <code>Isolation.RepeatableRead</code> but not <code>Isolation.ReadCommitted</code>.</p>
<h3 id="why-does-it-do-those-things">Why does it do those things?</h3>
<p>It is a truth universally acknowledged that <a href="https://en.wikipedia.org/wiki/Object-relational_impedance_mismatch">ORMs aren’t very good</a>.</p>
<p>I like SQL, and Postgres especially. In my experience, abstractions that obscure the underlying SQL, or that prioritise ease of switching to another database tomorrow over effective use of <em>this</em> database <em>today</em>, are a source of misery.</p>
<p>I’ve also come to love strongly typed languages, and TypeScript in particular. VS Code’s type checking and autocomplete speed development, prevent bugs, and simplify refactoring. Especially when they <em>just happen</em>, they bring joy. But, traditionally, talking to the database is a place where they really don’t <em>just happen</em>.</p>
<p>Zapatos aims to minimise the misery of abstraction, intensify the pleasures of type inference, and represent a credible alternative to traditional ORMs.</p>
<h3 id="what-doesnt-it-do">What doesn’t it do?</h3>
<p>Zapatos doesn’t handle schema migrations. Other tools can help you with this: check out <a href="https://github.com/amacneil/dbmate">dbmate</a>, for instance.</p>
<p>It also doesn’t manage the connection pool for you, as some ORMs do — mainly because the <code>pg</code> module makes this so easy. For example, my <code>pgPool.ts</code> looks something like this:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pg <span class="hljs-keyword">from</span> <span class="hljs-string">'pg'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> pg.Pool({ connectionString: process.env.DATABASE_URL });</span></code></pre>
<p>Finally, it won’t tell you how to structure your code: Zapatos doesn’t deal in the ‘model’ classes beloved of traditional ORMs, just (fully-typed) <a href="https://twitter.com/_ericelliott/status/831965087749533698?lang=en">POJOs</a>.</p>
<h2 id="how-do-i-use-it">How do I use it?</h2>
<p>Zapatos provides a command line tool, which is run like so:</p>
<pre><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">npx zapatos</span></code></pre>
<p>This generates the TypeScript schema for your database in a folder named <code>zapatos/schema.ts</code>, and copies (or symlinks) the Zapatos source files into <code>zapatos/src</code>.</p>
<p><strong>You <em>must</em> import the Zapatos source files from this copied/symlinked directory, e.g. <code>from './zapatos/src'</code> , and <em>not</em> <code>from 'zapatos'</code> in the usual way (which would find them in <code>node_modules</code>).</strong></p>
<p>That’s because the source files depend on importing your custom, Zapatos-generated <code>schema.ts</code>, which they cannot do if they’re imported direct from <code>node_modules</code> in the usual way.</p>
<p>Of course, before you can run <code>npx zapatos</code>, you need to install and configure it.</p>
<h3 id="installation">Installation</h3>
<p>Install it with <code>npm</code>:</p>
<pre><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">npm install --save-dev zapatos</span></code></pre>
<p>If you are copying the source files, which is the recommended default, you can make the library a <code>devDependency</code> with <code>--save-dev</code> (conversely, if you are symlinking them, which is not recommended, you will need the library as a standard <code>dependency</code> with plain old <code>--save</code>).</p>
<h3 id="configuration">Configuration</h3>
<p>Add a top-level file <code>zapatosconfig.json</code> to your project. Here’s an example:</p>
<pre class="language-json"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"db"</span>: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"connectionString"</span>: <span class="hljs-string">"postgresql://localhost/example_db"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"outDir"</span>: <span class="hljs-string">"./src"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"schemas"</span>: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"public"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"include"</span>: <span class="hljs-string">"*"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"exclude"</span>: [<span class="hljs-string">"excluded_table_1"</span>, <span class="hljs-string">"excluded_table_2"</span>]</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>This file has up to four top-level keys:</p>
<ul>
<li>
<p><code>"db"</code> gives Postgres connection details. You can provide <a href="https://node-postgres.com/features/connecting#Programmatic">anything that you’d pass</a> to <code>new pg.Pool(/* ... */)</code> here. This key is required.</p>
</li>
<li>
<p><code>"outDir"</code> defines where your <code>zapatos</code> folder will be created, relative to the project root. If not specified, it defaults to the project root, i.e. <code>"."</code>.</p>
</li>
<li>
<p><code>"srcMode"</code> can take the values <code>"copy"</code> (the default) or <code>"symlink"</code>, determining whether <code>zapatos/src</code> will be a copy of the folder <code>node_modules/zapatos/src</code> or just a symlink to it. The symlink option can cause enormous headaches with tools like <code>ts-node</code> and <code>ts-jest</code>, which refuse to compile anything inside <code>node_modules</code>, and is not recommended.</p>
</li>
<li>
<p><code>"schemas"</code> is an object that lets you define schemas and tables to include and exclude. Each key is a schema name, and each value is an object with keys <code>"include"</code> and <code>"exclude"</code>. Those keys can take the values <code>"*"</code> (for all tables in schema) or an array of table names. The <code>"exclude"</code> list takes precedence over the <code>"include"</code> list.</p>
<p>Note that schemas are not fully supported by Zapatos, since they are not included in the output types, but they will work by using Postgres’s search path if none of your table names is duplicated across different schemas.</p>
<p>If not specified, the default value for <code>"schemas"</code> includes all tables in the <code>public</code> schema, i.e.:</p>
<pre class="language-json"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">"schemas": {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  "public": {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    "include": "*",</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    "exclude: []</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>One more example: if you use PostGIS, you’ll likely want to exclude its system tables:</p>
<pre class="language-json"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">"schemas": {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  "public": {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    "include": "*",</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    "exclude": [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      "geography_columns", </span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      "geometry_columns", </span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      "raster_columns", </span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      "raster_overviews", </span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      "spatial_ref_sys"</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
</li>
</ul>
<h4 id="environment-variables">Environment variables</h4>
<p>All values in <code>zapatosconfig.json</code> can have environment variables (Node’s <code>process.env.SOMETHING</code>) interpolated via <a href="https://handlebarsjs.com/">handlebars</a>-style doubly-curly-brackets <code>{{variables}}</code>.</p>
<p>This is likely most useful for the database connection details. For example, on Heroku you’d probably configure your database as:</p>
<pre class="language-json"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">"db": {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  "connectionString": "{{DATABASE_URL}}"</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<h4 id="eslint--tslint">ESLint / tslint</h4>
<p>One general configuration suggestion: set up <a href="https://github.com/typescript-eslint/typescript-eslint/blob/master/docs/getting-started/linting/README.md">ESLint</a> with the rules <code>@typescript-eslint/await-thenable</code> and <code>@typescript-eslint/no-floating-promises</code> (or <a href="https://palantir.github.io/tslint/">tslint</a> with <a href="https://palantir.github.io/tslint/rules/no-floating-promises/"><code>no-floating-promises</code></a> and <a href="https://palantir.github.io/tslint/rules/await-promise/"><code>await-promise</code></a>) to avoid <code>Promise</code>-related pitfalls.</p>
<h2 id="user-guide">User guide</h2>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/core.ts#L117">Source code »</a></div>
<h3 id="sql-tagged-template-strings"><code>sql</code> tagged template strings</h3>
<p>Arbitrary queries are written using the tagged template function <code>sql</code>, which returns <a href="#sqlfragment"><code>SQLFragment</code></a> class instances.</p>
<p>The <code>sql</code> function is <a href="https://www.typescriptlang.org/docs/handbook/generics.html">generic</a>, having two type variables. For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> authors = <span class="hljs-keyword">await</span> db.sql&lt;s.authors.SQL, s.authors.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT * FROM <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>`</span>.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> *</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Louis Sachar"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Gabriel Garcia Marquez"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Douglas Adams"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Jane Austen"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>The first type variable, <code>Interpolations</code> (above: <code>s.authors.SQL</code>), defines allowable interpolation values. If we were joining the <code>authors</code> and <code>books</code> tables, say, then we could specify <code>s.authors.SQL | s.books.SQL</code> here.</p>
<p>The <code>Interpolations</code> type variable defaults to <code>db.SQL</code> if not specified. This is the union of all per-table <code>SQL</code> types, and thus allows all table and column names present in the database as string interpolations. However, TypeScript will infer a more specific type from the first interpolated value, and&nbsp;if you have multiple interpolated values of different types then you may need to specify a value explicitly (either <code>db.SQL</code> or something more precise).</p>
<p>The second type variable, <code>RunResult</code> (above: <code>s.authors.Selectable[]</code>), describes what will be returned if we call <code>run()</code> on the query (after any transformations performed in <a href="#runresulttransform-qr-pgqueryresult--any"><code>runResultTransform()</code></a>), or if we embed it within the <a href="#extras"><code>extras</code></a> or <a href="#lateral-and-alias"><code>lateral</code></a> query options. Its default value if not specified is <code>any[]</code>.</p>
<p>Take another example of these type variables:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [{ random }] = <span class="hljs-keyword">await</span> db.sql&lt;never, [{ random: <span class="hljs-built_in">number</span> }]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT random()`</span>.run(pool);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-built_in">console</span>.log(random);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> random()</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"random"</span>: <span class="hljs-number">0.138975871261209</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="console"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">0.138975871261209</span></code></pre>
</div>
<p><code>Interpolations</code> is <code>never</code> because nothing needs to be interpolated in this query, and the <code>RunResult</code> type says that the query will return one row comprising one numeric column, named <code>random</code>. The <code>random</code> TypeScript variable we initialize will of course be typed as a <code>number</code>.</p>
<p>If you’re happy to have your types tied down a little less tightly, it also works to wholly omit the type variables in this particular query, falling back on their defaults:</p>
<pre class="language-typescript noresult runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [{ random }] = <span class="hljs-keyword">await</span> db.sql<span class="hljs-string">`SELECT random()`</span>.run(pool);</span></code></pre>
<p>In this case, the <code>random</code> variable is of course still a <code>number</code>, but it is typed as <code>any</code>.</p>
<h3 id="sql-template-interpolation-types"><code>sql</code> template interpolation types</h3>
<h4 id="strings">Strings</h4>
<p>The strings that can be directly interpolated into a <code>sql</code> template string are defined by its <code>Interpolations</code> type variable, <a href="#sql-tagged-template-strings">as noted above</a>. Typically, this will limit them to the names of tables and columns.</p>
<p>Interpolated strings are passed through to the raw SQL query double-quoted,&nbsp;to preserve capitalisation and neutralise SQL keywords, but otherwise unchanged.</p>
<p>It’s highly preferable to use interpolated string literals for table and column names rather than just writing those values in the query itself, in order to benefit from auto-completion and (ongoing) type-checking.</p>
<p>So, for example, do write:</p>
<pre class="language-typescript noresult runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> title = <span class="hljs-keyword">await</span> db.sql<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT <span class="hljs-subst">${<span class="hljs-string">"title"</span>}</span> FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> LIMIT 1`</span>.run(pool);</span></code></pre>
<p>But <strong>don’t</strong> write</p>
<pre class="language-typescript noresult runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> title = <span class="hljs-keyword">await</span> db.sql<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT "title" FROM "books" LIMIT 1`</span>.run(pool);  <span class="hljs-comment">// no, don't do this</span></span></code></pre>
<p>—&nbsp;even if the two produce the same result right now.</p>
<p>More critically, <strong>never</strong> override the type-checking so as to write:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  nameSubmittedByUser = <span class="hljs-string">'books"; DROP TABLE "authors"; --'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  title = <span class="hljs-keyword">await</span> db.sql&lt;<span class="hljs-built_in">any</span>&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT * FROM <span class="hljs-subst">${nameSubmittedByUser}</span> LIMIT 1`</span>.run(pool);  <span class="hljs-comment">// NEVER do this!</span></span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> *</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"authors"</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-comment">--" LIMIT 1</span></span></code></pre>
</div>
<p>If you override type-checking to pass untrusted data to Zapatos in unexpected places, such as the above use of <code>any</code>, you can expect successful SQL injection attacks. (It <em>is</em> safe to pass untrusted data as values in <code>Whereable</code>, <code>Insertable</code>, and <code>Updatable</code> objects, manually by using <a href="#paramvalue-any-parameter"><code>param</code></a>, and in certain other places. If you’re in any doubt, check whether the generated SQL is using <code>$1</code>, <code>$2</code>, … parameters).</p>
<h4 id="cols-and-vals"><code>cols()</code> and <code>vals()</code></h4>
<p>The <code>cols</code> and <code>vals</code> wrapper functions (which return <code>ColumnNames</code> and <code>ColumnValues</code> class instances respectively) are intended to help with <code>INSERT</code> queries.</p>
<p>Pass them each the same <code>Insertable</code> object: <code>cols</code> is compiled to a comma-separated list of the object’s keys, which are the column names, and <code>vals</code> is compiled to a comma-separated list of SQL placeholders (<code>$1</code>, <code>$2</code>, …) associated with the corresponding values, in matching order. To return to (approximately) an earlier example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  author: s.authors.Insertable = {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    name: <span class="hljs-string">'Joseph Conrad'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    isLiving: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  [insertedAuthor] = <span class="hljs-keyword">await</span> db.sql&lt;s.authors.SQL, s.authors.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    INSERT INTO <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span> (<span class="hljs-subst">${db.cols(author)}</span>)</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    VALUES (<span class="hljs-subst">${db.vals(author)}</span>) RETURNING *`</span>.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"authors"</span> (<span class="hljs-string">"isLiving"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> *</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-literal">false</span>, <span class="hljs-string">"Joseph Conrad"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">4</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Joseph Conrad"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>A second use for the <code>cols</code> function is in selecting only a subset of columns, in conjunction with the <code>OnlyCols</code> type. Pass an array of column names to <code>cols</code>, and they’re compiled appropriately, as seen in this example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-comment">// the &lt;const&gt; prevents generalization to string[]</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> bookCols = &lt;<span class="hljs-keyword">const</span>&gt;[<span class="hljs-string">'id'</span>, <span class="hljs-string">'title'</span>];</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> BookDatum = s.books.OnlyCols&lt;<span class="hljs-keyword">typeof</span> bookCols&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  bookData = <span class="hljs-keyword">await</span> db.sql&lt;s.books.SQL, BookDatum[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT <span class="hljs-subst">${db.cols(bookCols)}</span> FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>`</span>.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">"id"</span>, <span class="hljs-string">"title"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1004</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Holes"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<h4 id="whereable"><code>Whereable</code></h4>
<p>Any plain JavaScript object interpolated into a <code>sql</code> template string is type-checked as a <code>Whereable</code>, and compiled into one or more conditions joined with <code>AND</code> (but, for flexibility, no <code>WHERE</code>). The object’s keys represent column names, and the corresponding values are compiled as (injection-safe) parameters.</p>
<p>For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  title = <span class="hljs-string">'Northern Lights'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  books = <span class="hljs-keyword">await</span> db.sql&lt;s.books.SQL, s.books.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT * FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> WHERE <span class="hljs-subst">${{ title }</span>}`</span>.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> *</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"title"</span> = $<span class="hljs-number">1</span>)</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"Northern Lights"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.971Z"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>A <code>Whereable</code>'s values can also be <code>SQLFragments</code>, however, and this makes them extremely flexible. In a <code>SQLFragment</code> inside a <code>Whereable</code>, the special symbol <code>self</code> can be used to refer to the column name. This arrangement enables us to use any operator or function we want — not just <code>=</code>.</p>
<p>For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  titleLike = <span class="hljs-string">`Northern%`</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  books = <span class="hljs-keyword">await</span> db.sql&lt;s.books.SQL, s.books.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT * FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> WHERE <span class="hljs-subst">${{ </span></span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string"><span class="hljs-subst">      title: db.sql&lt;db.SQL&gt;<span class="hljs-string">`<span class="hljs-subst">${db.self}</span> LIKE <span class="hljs-subst">${db.param(titleLike)}</span>`</span>,</span></span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string"><span class="hljs-subst">      createdAt: db.sql&lt;db.SQL&gt;<span class="hljs-string">`<span class="hljs-subst">${db.self}</span> &gt; now() - INTERVAL '7 days'`</span>,</span></span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string"><span class="hljs-subst">    }</span>}`</span>.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> *</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> ((<span class="hljs-string">"createdAt"</span> &gt; <span class="hljs-keyword">now</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 days'</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">AND</span> (<span class="hljs-string">"title"</span> <span class="hljs-keyword">LIKE</span> $<span class="hljs-number">1</span>))</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"Northern%"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.971Z"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<h4 id="self"><code>self</code></h4>
<p>The use of the <code>self</code> symbol is explained in <a href="#whereable">the section on <code>Whereable</code>s</a>.</p>
<h4 id="paramvalue-any-parameter"><code>param(value: any): Parameter</code></h4>
<p>In general, Zapatos’ type-checking won’t let us <a href="https://xkcd.com/327/">pass user-supplied data unsafely into a query</a> by accident. The <code>param</code> wrapper function exists to enable the safe passing of user-supplied data into a query using numbered query parameters (<code>$1</code>, <code>$2</code>, …).</p>
<p>For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  title = <span class="hljs-string">'Pride and Prejudice'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  books = <span class="hljs-keyword">await</span> db.sql&lt;s.books.SQL, s.books.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT * FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> WHERE <span class="hljs-subst">${<span class="hljs-string">"title"</span>}</span> = <span class="hljs-subst">${db.param(title)}</span>`</span>.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> *</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> <span class="hljs-string">"title"</span> = $<span class="hljs-number">1</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"Pride and Prejudice"</span>]</span></code></pre>
</div>
<p>This same mechanism is applied automatically when we use <a href="#whereable">a <code>Whereable</code> object</a> (and in this example, using a <code>Whereable</code> would be more readable and more concise). It’s also applied when we use <a href="#cols-and-vals">the <code>vals</code> function</a> to create a <code>ColumnValues</code> wrapper object.</p>
<h4 id="default"><code>default</code></h4>
<p>The <code>default</code> symbol simply compiles to the SQL <code>DEFAULT</code> keyword. This may be useful in <code>INSERT</code> and <code>UPDATE</code> queries where no value is supplied for one or more of the affected columns.</p>
<h4 id="sql-template-strings"><code>sql</code> template strings</h4>
<p><code>sql</code> template strings (resulting in <code>SQLFragment</code>s) can be interpolated within other <code>sql</code> template strings (<code>SQLFragment</code>s). This provides flexibility in building queries programmatically.</p>
<p>For example, the <a href="#select-selectone-and-count"><code>select</code> shortcut</a> makes extensive use of nested <code>sql</code> templates to build its queries:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  rowsQuery = sql&lt;SQL, <span class="hljs-built_in">any</span>&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT <span class="hljs-subst">${allColsSQL}</span> AS result </span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    FROM <span class="hljs-subst">${table}</span><span class="hljs-subst">${tableAliasSQL}</span></span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    <span class="hljs-subst">${lateralSQL}</span><span class="hljs-subst">${whereSQL}</span><span class="hljs-subst">${orderSQL}</span><span class="hljs-subst">${limitSQL}</span><span class="hljs-subst">${offsetSQL}</span>`</span>,</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// we need the aggregate function, if one's needed, to sit in an outer </span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// query, to keep ORDER and LIMIT working normally in the main query</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  query = mode !== SelectResultMode.Many ? rowsQuery :</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    sql&lt;SQL, <span class="hljs-built_in">any</span>&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string">      SELECT coalesce(jsonb_agg(result), '[]') AS result </span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string">      FROM (<span class="hljs-subst">${rowsQuery}</span>) AS <span class="hljs-subst">${raw(<span class="hljs-string">`"sq_<span class="hljs-subst">${aliasedTable}</span>"`</span>)}</span>`</span>;</span></code></pre>
<h4 id="arrays">Arrays</h4>
<p>Items in an interpolated array are treated just the same as if they had been interpolated directly. This, again, can be useful for building queries programmatically.</p>
<p>To take the <a href="#select-selectone-and-count"><code>select</code> shortcut</a> as our example again, an interpolated array is used to generate <code>LATERAL JOIN</code> query elements from the <code>lateral</code> option, like so:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateralOpt = allOptions.lateral,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateralSQL = lateralOpt === <span class="hljs-literal">undefined</span> ? [] :</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-built_in">Object</span>.keys(lateralOpt).map(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">const</span> subQ = lateralOpt[k];</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      subQ.parentTable = aliasedTable;  <span class="hljs-comment">// enables `parent()` in subquery's Wherables</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">return</span> sql&lt;SQL&gt;<span class="hljs-string">` LEFT JOIN LATERAL (<span class="hljs-subst">${subQ}</span>) AS <span class="hljs-subst">${raw(<span class="hljs-string">`"cj_<span class="hljs-subst">${k}</span>"`</span>)}</span> ON true`</span>;</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    });</span></code></pre>
<p>The <code>lateralSQL</code> variable — a <code>SQLFragment[]</code> —&nbsp;is subsequently interpolated into the final query (some additional SQL using <code>jsonb_build_object()</code> is interpolated earlier in that query, to return the result of the lateral subquery alongside the main query columns).</p>
<p>Note that a useful idiom also seen here is the use of the empty array (<code>[]</code>) to conditionally interpolate nothing at all.</p>
<h4 id="rawvalue-string-dangerousrawstring"><code>raw(value: string): DangerousRawString</code></h4>
<p>The <code>raw</code> function returns <code>DangerousRawString</code> wrapper instances. This represents an escape hatch, enabling us to interpolate arbitrary strings into queries in contexts where the <code>param</code> wrapper is unsuitable (such as when we’re interpolating basic SQL syntax elements). <strong>If you pass user-controlled data to this function you will open yourself up to SQL injection attacks.</strong></p>
<h4 id="parentcolumnname-string-parentcolumn"><code>parent(columnName: string): ParentColumn</code></h4>
<p>Within <code>select</code>, <code>selectOne</code> or <code>count</code> queries passed as subqueries to the <code>lateral</code> option of <code>select</code> or <code>selectOne</code>, the <code>parent()</code> wrapper can be used to refer to a column of the table that’s the subject of the immediately containing query. For details, see the <a href="#lateral-and-alias">documentation for the <code>lateral</code> option</a>.</p>
<h3 id="sqlfragment"><code>SQLFragment</code></h3>
<p><code>SQLFragment&lt;RunResult&gt;</code> class instances are what is returned by the <code>sql</code> tagged template function —&nbsp;you’re unlikely ever to contruct them directly with <code>new</code>. They take on the <code>RunResult</code> type variable from the <code>sql</code> template function that constructs them.</p>
<p>You can <a href="#sql-template-strings">interpolate them</a> into other <code>sql</code> tagged template strings, or call/access the following properties on them:</p>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/core.ts#L159">Source code »</a></div>
<h4 id="async-runqueryable-queryable-promiserunresult"><code>async run(queryable: Queryable): Promise&lt;RunResult&gt;</code></h4>
<p>The <code>run</code> function compiles, executes, and returns the transformed result of the query represented by this <code>SQLFragment</code>. The <code>awaited</code> return value is typed according to the <code>SQLFragment</code>'s <code>RunResult</code> type variable.</p>
<p>Taking that one step at a a time:</p>
<ol>
<li>
<p>First, <a href="#compile-sqlquery">the <code>compile</code> function</a> is called, recursively compiling this <code>SQLFragment</code> and its interpolated values into a <code>{ text: '', values: [] }</code> query that can be passed straight to the <code>pg</code> module. If a <code>queryListener</code> function <a href="#run-time-configuration">has been configured</a>, it is called with the query as its argument now.</p>
</li>
<li>
<p>Next, the compiled SQL query is executed against the supplied <code>Queryable</code>, which is defined as a <code>pg.Pool</code> or <code>pg.ClientBase</code> (this definition covers the <code>TxnClient</code> provided by the <a href="#transaction"><code>transaction</code> helper function</a>).</p>
</li>
<li>
<p>Finally, the result returned from <code>pg</code> is fed through this <code>SQLFragment</code>'s <a href="#runresulttransform-qr-pgqueryresult--any"><code>runResultTransform()</code></a> function, whose default implementation simply returns the <code>rows</code> property of the result. If a <code>resultListener</code> function <a href="#run-time-configuration">has been configured</a>, it is called with the transformed result as its argument now.</p>
</li>
</ol>
<p>Examples of the <code>run</code> function are scattered throughout this documentation.</p>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/core.ts#L178">Source code »</a></div>
<h4 id="compile-sqlquery"><code>compile(): SQLQuery</code></h4>
<p>The <code>compile</code> function recursively transforms this <code>SQLFragment</code> and its interpolated values into a <code>SQLQuery</code> object (<code>{ text: string; values: any[]; }</code>) that can be passed straight to the <code>pg</code> module. It is called without arguments (the arguments it can take are for internal use).</p>
<p>For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  authorId = <span class="hljs-number">12</span>,  <span class="hljs-comment">// from some untrusted source</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  query = db.sql&lt;s.books.SQL, s.books.Selectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT * FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> WHERE <span class="hljs-subst">${{authorId}</span>}`</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  compiled = query.compile();</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-built_in">console</span>.log(compiled);</span></code></pre><div class="sqlstuff">
<pre class="console"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  text: '\n    SELECT * FROM "books" WHERE ("authorId" = $1)',</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  values: [ 12 ]</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
</div>
<p>You may never need this function. Use it if and when you want to see the SQL that would be executed by the <code>run</code> function, without in fact executing it.</p>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/core.ts#L148">Source code »</a></div>
<h4 id="runresulttransform-qr-pgqueryresult--any"><code>runResultTransform: (qr: pg.QueryResult) =&gt; any</code></h4>
<p>When you call <code>run</code>, the function stored in this property is applied to the <code>QueryResult</code> object returned by <code>pg</code>, in order to produce the result that the <code>run</code> function ultimately returns.</p>
<p>By default, the <code>QueryResult</code>’s <code>rows</code> property (which is an array) is returned: that is, the default implementation is just <code>qr =&gt; qr.rows</code>. However, the <a href="#shortcut-functions-and-lateral-joins">shortcut functions</a> supply their own <code>runResultTransform</code> implementations in order to match their declared <code>RunResult</code> types.</p>
<p>Generally you will not need to call this function directly, but there may be cases where you want to assign a new function to replace the default implementation.</p>
<p>For example, imagine we wanted to create a function returning a query that, when run, returns the current database timestamp directly as a <code>Date</code>. We could do so like this:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dbNowQuery</span>(<span class="hljs-params"></span>) </span>{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">const</span> query = db.sql&lt;never, <span class="hljs-built_in">Date</span>&gt;<span class="hljs-string">`SELECT now()`</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  query.runResultTransform = <span class="hljs-function"><span class="hljs-params">qr</span> =&gt;</span> qr.rows[<span class="hljs-number">0</span>].now;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">return</span> query;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> dbNow = <span class="hljs-keyword">await</span> dbNowQuery().run(pool);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-comment">// dbNow is a Date: the result you can toggle below has come via JSON.stringify</span></span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">now</span>()</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-string">"2020-05-28T12:53:08.551Z"</span></span></code></pre>
</div>
<p>Note that the <code>RunResult</code> type variable on the <code>sql</code> template function (in this case, <code>Date</code>) must reflect the type of the <em>transformed</em> result, not what comes straight back from <code>pg</code> (which in this case is roughly <code>{ rows: [{ now: Date }] }</code>).</p>
<p>If a <code>SQLFragment</code> does not have <code>run</code> called on it directly —&nbsp;for example, if it is instead interpolated into another <code>SQLFragment</code>, or given as the value of the <code>lateral</code> option to the <code>select</code> shortcut — then the <code>runResultTransform</code> function is never applied.</p>
<h3 id="manual-joins-using-postgres-json-features">Manual joins using Postgres’ JSON features</h3>
<p>We can make use of Postgres’ excellent JSON support to achieve a variety of <code>JOIN</code> queries. That’s not unique to Zapatos, of course, but it may be helpful to consider a few example queries in this context.</p>
<p>Take this example, retrieving each book with its (single) author:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> bookAuthorSQL = s.books.SQL | s.authors.SQL | <span class="hljs-string">"author"</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> bookAuthorSelectable = s.books.Selectable &amp; { author: s.authors.Selectable };</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> query = db.sql&lt;bookAuthorSQL, bookAuthorSelectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>.*, to_jsonb(<span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.*) as <span class="hljs-subst">${<span class="hljs-string">"author"</span>}</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> JOIN <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span> </span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  ON <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"authorId"</span>}</span> = <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"id"</span>}</span>`</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> bookAuthors = <span class="hljs-keyword">await</span> query.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">"books"</span>.*, to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">as</span> <span class="hljs-string">"author"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">JOIN</span> <span class="hljs-string">"authors"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"books"</span>.<span class="hljs-string">"authorId"</span> = <span class="hljs-string">"authors"</span>.<span class="hljs-string">"id"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.971Z"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.972Z"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.972Z"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.976Z"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1004</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Holes"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T12:52:59.977Z"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Louis Sachar"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>Of course, we might also want the converse query, retrieving each author with their (many) books. This is also easy enough to arrange:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> authorBooksSQL = s.authors.SQL | s.books.SQL;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> authorBooksSelectable = s.authors.Selectable &amp; { books: s.books.Selectable[] };</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> query = db.sql&lt;authorBooksSQL, authorBooksSelectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.*, jsonb_agg(<span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>.*) AS <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  FROM <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span> JOIN <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span> </span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  ON <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"id"</span>}</span> = <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"authorId"</span>}</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  GROUP BY <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"id"</span>}</span>`</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> authorBooks = <span class="hljs-keyword">await</span> query.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">"authors"</span>.*, jsonb_agg(<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">JOIN</span> <span class="hljs-string">"books"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"authors"</span>.<span class="hljs-string">"id"</span> = <span class="hljs-string">"books"</span>.<span class="hljs-string">"authorId"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">"authors"</span>.<span class="hljs-string">"id"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Louis Sachar"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1004</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Holes"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.977396+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>Note that if you want to include authors with no books, you need a <code>LEFT JOIN</code> in this query, and then you’ll also want to fix the annoying <a href="https://stackoverflow.com/questions/24155190/postgresql-left-join-json-agg-ignore-remove-null"><code>[null]</code> array results <code>jsonb_agg</code> will return for those authors</a>.</p>
<p>Rather than do it that way, though, we can achieve the same result using a <a href="https://medium.com/kkempin/postgresqls-lateral-join-bfd6bd0199df"><code>LATERAL JOIN</code></a> instead:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> authorBooksSQL = s.authors.SQL | s.books.SQL;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> authorBooksSelectable = s.authors.Selectable &amp; { books: s.books.Selectable[] };</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> query = db.sql&lt;authorBooksSQL, authorBooksSelectable[]&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  SELECT <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.*, bq.* </span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  FROM <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span> LEFT JOIN LATERAL (</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    SELECT coalesce(json_agg(<span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>.*), '[]') AS <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span></span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    FROM <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span></span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    WHERE <span class="hljs-subst">${<span class="hljs-string">"books"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"authorId"</span>}</span> = <span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"id"</span>}</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  ) bq ON true`</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> authorBooks = <span class="hljs-keyword">await</span> query.run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">"authors"</span>.*, bq.*</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(json_agg(<span class="hljs-string">"books"</span>.*), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">WHERE</span> <span class="hljs-string">"books"</span>.<span class="hljs-string">"authorId"</span> = <span class="hljs-string">"authors"</span>.<span class="hljs-string">"id"</span>) bq <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Louis Sachar"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1004</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Holes"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.977396+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ]</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Gabriel Garcia Marquez"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: []</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Douglas Adams"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: []</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Jane Austen"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: []</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">4</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Joseph Conrad"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: []</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>Lateral joins of this sort are very flexible, and can be nested multiple levels deep — but can quickly become quite hairy in that case. The <a href="#select-selectone-and-count"><code>select</code> shortcut function</a> and its <a href="#lateral-and-alias"><code>lateral</code> option</a> can make this much less painful.</p>
<h3 id="shortcut-functions-and-lateral-joins">Shortcut functions and lateral joins</h3>
<p>A key contribution of Zapatos is a set of simple shortcut functions that make everyday <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> queries extremely easy to work with. Furthermore, the <code>select</code> shortcut can be nested in order to generate <a href="https://www.postgresql.org/docs/12/queries-table-expressions.html#id-1.5.6.6.5.10.2">LATERAL JOIN</a> queries, resulting in arbitrarily complex nested JSON structures with inputs and outputs that are still fully and automatically typed.</p>
<p>Because the shortcuts make heavy use of Postgres’s JSON support, their return values are generally <code>JSONSelectable</code>s rather than plain <code>Selectable</code>s. The only difference between these types is that, because JSON has no native <code>Date</code> representation, columns that would have been returned as <code>Date</code> values in a <code>Selectable</code> are instead returned as ISO 8601 strings (the result of calling <code>toJSON()</code> on them) in a <code>JSONSelectable</code>.</p>
<p>Since you’re using Node, it’s safe to convert this string straight back to a <code>Date</code> by passing it to <code>new Date()</code> (web browsers’ date parsing may vary). But since JavaScript’s built-in date/time support is terrible, you’re probably anyway better off using a library such as <a href="https://moment.github.io/luxon/">Luxon</a> (where you would instead use <code>DateTime.fromISO()</code>);</p>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/shortcuts.ts#L47">Source code »</a></div>
<h4 id="insert"><code>insert</code></h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">interface</span> InsertSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(table: T, values: InsertableForTable&lt;T&gt;): SQLFragment&lt;JSONSelectableForTable&lt;T&gt;&gt;;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(table: T, values: InsertableForTable&lt;T&gt;[]): SQLFragment&lt;JSONSelectableForTable&lt;T&gt;[]&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>The <code>insert</code> shortcut inserts one or more rows in a table, and returns them with any <code>DEFAULT</code> values filled in. It takes a <code>Table</code> name and the corresponding <code>Insertable</code> or <code>Insertable[]</code>, and returns the corresponding <code>JSONSelectable</code> or <code>JSONSelectable[]</code>.</p>
<p>For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// insert one</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  steve = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'authors'</span>, { </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    name: <span class="hljs-string">'Steven Hawking'</span>, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    isLiving: <span class="hljs-literal">false</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// insert many</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  [time, me] = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'books'</span>, [{ </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    authorId: steve.id, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    title: <span class="hljs-string">'A Brief History of Time'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    createdAt: db.sql<span class="hljs-string">`now()`</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }, { </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    authorId: steve.id, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    title: <span class="hljs-string">'My Brief History'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    createdAt: db.sql<span class="hljs-string">`now()`</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }]).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  tags = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'tags'</span>, [</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { bookId: time.id, tag: <span class="hljs-string">'physics'</span> },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { bookId: me.id, tag: <span class="hljs-string">'physicist'</span> },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { bookId: me.id, tag: <span class="hljs-string">'autobiography'</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ]).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"authors"</span> (<span class="hljs-string">"isLiving"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-literal">false</span>, <span class="hljs-string">"Steven Hawking"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Steven Hawking"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"books"</span> (<span class="hljs-string">"authorId"</span>, <span class="hljs-string">"createdAt"</span>, <span class="hljs-string">"title"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, <span class="hljs-keyword">now</span>(), $<span class="hljs-number">2</span>), ($<span class="hljs-number">3</span>, <span class="hljs-keyword">now</span>(), $<span class="hljs-number">4</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">5</span>, <span class="hljs-string">"A Brief History of Time"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"My Brief History"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"A Brief History of Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"tags"</span> (<span class="hljs-string">"bookId"</span>, <span class="hljs-string">"tag"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>), ($<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>), ($<span class="hljs-number">5</span>, $<span class="hljs-number">6</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"tags"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1</span>, <span class="hljs-string">"physics"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"physicist"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"autobiography"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"physics"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"physicist"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"autobiography"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>You’ll note that <code>Insertable</code>s can take <code>SQLFragment</code> values (from the <code>sql</code> tagged template function) as well as direct values (strings, numbers, and so on).</p>
<p>Postgres can accept up to 65,536 parameters per query (since <a href="https://stackoverflow.com/a/49379324/338196">an Int16 is used</a> to convey the number of parameters in the <em>Bind</em> message of the <a href="https://www.postgresql.org/docs/current/protocol-message-formats.html">wire protocol</a>). If there’s a risk that a multiple-row <code>INSERT</code> could have more inserted values than that, you’ll need a mechanism to batch them up into separate calls.</p>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/shortcuts.ts#L147">Source code »</a></div>
<h4 id="update"><code>update</code></h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">interface</span> UpdateSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(table: T, values: UpdatableForTable&lt;T&gt;, where: WhereableForTable&lt;T&gt; | SQLFragment): SQLFragment&lt;JSONSelectableForTable&lt;T&gt;[]&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>The <code>update</code> shortcut updates rows in the database. It takes a <code>Table</code> name and a corresponding <code>Updatable</code> and <code>Whereable</code> —&nbsp;in that order, matching the order in a raw SQL query. It returns a corresponding <code>JSONSelectable[]</code>, listing every row affected.</p>
<p>For example, when we discover with that we’ve mis-spelled a famous physicist’s name, we can do this:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.update(<span class="hljs-string">'authors'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Stephen Hawking'</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Steven Hawking'</span> }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">UPDATE</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SET</span> (<span class="hljs-string">"name"</span>) = <span class="hljs-keyword">ROW</span> ($<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"name"</span> = $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"Stephen Hawking"</span>, <span class="hljs-string">"Steven Hawking"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Stephen Hawking"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>Like <code>Insertable</code> values, <code>Updatable</code> values can also be <code>SQLFragment</code>s. For instance, take a table such as the following:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"emailAuthentication"</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"email"</span> citext PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"consecutiveFailedLogins"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"lastFailedLogin"</span> TIMESTAMPTZ );</span></code></pre>
<p>To atomically increment the <code>consecutiveFailedLogins</code> value, we can do something like this:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.update(<span class="hljs-string">"emailAuthentication"</span>, { </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  consecutiveFailedLogins: db.sql<span class="hljs-string">`<span class="hljs-subst">${db.self}</span> + 1`</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lastFailedLogin: db.sql<span class="hljs-string">`now()`</span>,</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}, { email: <span class="hljs-string">'me@privacy.net'</span> }).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">UPDATE</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">"emailAuthentication"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SET</span> (<span class="hljs-string">"consecutiveFailedLogins"</span>, <span class="hljs-string">"lastFailedLogin"</span>) = <span class="hljs-keyword">ROW</span> (<span class="hljs-string">"consecutiveFailedLogins"</span> + <span class="hljs-number">1</span>, <span class="hljs-keyword">now</span>())</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"email"</span> = $<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"emailAuthentication"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"me@privacy.net"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"me@privacy.net"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"lastFailedLogin"</span>: <span class="hljs-string">"2020-05-28T13:53:10.343737+01:00"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"consecutiveFailedLogins"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/shortcuts.ts#L78">Source code »</a></div>
<h4 id="upsert"><code>upsert</code></h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">interface</span> UpsertAction { $action: <span class="hljs-string">'INSERT'</span> | <span class="hljs-string">'UPDATE'</span>; }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> UpsertReturnableForTable&lt;T <span class="hljs-keyword">extends</span> Table&gt; = JSONSelectableForTable&lt;T&gt; &amp; UpsertAction;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> UpsertConflictTargetForTable&lt;T <span class="hljs-keyword">extends</span> Table&gt; = Constraint&lt;T&gt; | ColumnForTable&lt;T&gt; | ColumnForTable&lt;T&gt;[];</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">interface</span> UpsertSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(table: T, values: InsertableForTable&lt;T&gt;, conflictTarget: UpsertConflictTargetForTable&lt;T&gt;, noNullUpdateCols?: ColumnForTable&lt;T&gt; | ColumnForTable&lt;T&gt;[]): SQLFragment&lt;UpsertReturnableForTable&lt;T&gt;&gt;;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(table: T, values: InsertableForTable&lt;T&gt;[], conflictTarget: UpsertConflictTargetForTable&lt;T&gt;, noNullUpdateCols?: ColumnForTable&lt;T&gt; | ColumnForTable&lt;T&gt;[]): SQLFragment&lt;UpsertReturnableForTable&lt;T&gt;[]&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>The <code>upsert</code> shortcut issues an <a href="https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT"><code>INSERT ... ON CONFLICT ... DO UPDATE</code></a> query. Like <code>insert</code>, it takes a <code>Table</code> name and a corresponding <code>Insertable</code> or <code>Insertable[]</code>.</p>
<p>It then takes, in addition, a column name (or an array thereof) or an appropriate unique index as the conflict target: the ‘arbiter index(es)’ on which a conflict is to be detected. Optionally, it can also take a column name or array of column names which are not to be overwritten with <code>NULL</code> in the case that the <code>UPDATE</code> branch is taken.</p>
<p>It returns an <code>UpsertReturnable</code> or <code>UpsertReturnable[]</code>. An <code>UpsertReturnable</code> is the same as a <code>JSONSelectable</code> except that it includes one additional property, <code>$action</code>, taking the string <code>'INSERT'</code> or <code>'UPDATE'</code> so as to indicate which eventuality occurred for each row.</p>
<p>Let’s say we have a table of app subscription transactions:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"appleTransactions"</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"environment"</span> <span class="hljs-string">"appleEnvironment"</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>  <span class="hljs-comment">-- enum: 'PROD' or 'Sandbox'</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"originalTransactionId"</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"accountId"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">"accounts"</span>(<span class="hljs-string">"id"</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"latestReceiptData"</span> <span class="hljs-built_in">TEXT</span> );</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"appleTransactions"</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> <span class="hljs-string">"appleTransactionsPrimaryKey"</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">"environment"</span>, <span class="hljs-string">"originalTransactionId"</span>);</span></code></pre>
<p>When we receive a purchase receipt, we need to either store a new record or update an existing record for each distinct (<code>environment</code>, <code>originalTransactionId</code>) it contains.</p>
<p>We can <code>map</code> the transaction data in the receipt into an <code>appleTransactions.Insertable[]</code>, and do what’s needed with a single <code>upsert</code> call. In this example, though, we hard-code the <code>Insertable[]</code> for ease of exposition:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  newTransactions: s.appleTransactions.Insertable[] = [{</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    environment: <span class="hljs-string">'PROD'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    originalTransactionId: <span class="hljs-string">'123456'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    accountId: <span class="hljs-number">123</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    latestReceiptData: <span class="hljs-string">'TWFuIGlzIGRpc3Rp'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }, {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    environment: <span class="hljs-string">'PROD'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    originalTransactionId: <span class="hljs-string">'234567'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    accountId: <span class="hljs-number">234</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    latestReceiptData: <span class="hljs-string">'bmd1aXNoZWQsIG5v'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }],</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  result = <span class="hljs-keyword">await</span> db.upsert(<span class="hljs-string">'appleTransactions'</span>, newTransactions, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    [<span class="hljs-string">'environment'</span>, <span class="hljs-string">'originalTransactionId'</span>]).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"appleTransactions"</span> (<span class="hljs-string">"accountId"</span>, <span class="hljs-string">"environment"</span>, <span class="hljs-string">"latestReceiptData"</span>, <span class="hljs-string">"originalTransactionId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>, $<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>), ($<span class="hljs-number">5</span>, $<span class="hljs-number">6</span>, $<span class="hljs-number">7</span>, $<span class="hljs-number">8</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">ON</span> CONFLICT (<span class="hljs-string">"environment"</span>, <span class="hljs-string">"originalTransactionId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">DO</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    (<span class="hljs-string">"accountId"</span>, <span class="hljs-string">"latestReceiptData"</span>) = <span class="hljs-keyword">ROW</span> (EXCLUDED. <span class="hljs-string">"accountId"</span>, EXCLUDED. <span class="hljs-string">"latestReceiptData"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"appleTransactions"</span>.*) || jsonb_build_object(<span class="hljs-string">'$action'</span>, <span class="hljs-keyword">CASE</span> xmax</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">WHEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span></span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-string">'INSERT'</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">ELSE</span></span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-string">'UPDATE'</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">123</span>, <span class="hljs-string">"PROD"</span>, <span class="hljs-string">"TWFuIGlzIGRpc3Rp"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">234</span>, <span class="hljs-string">"PROD"</span>, <span class="hljs-string">"bmd1aXNoZWQsIG5v"</span>, <span class="hljs-string">"234567"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"$action"</span>: <span class="hljs-string">"UPDATE"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"accountId"</span>: <span class="hljs-number">123</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"environment"</span>: <span class="hljs-string">"PROD"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"latestReceiptData"</span>: <span class="hljs-string">"TWFuIGlzIGRpc3Rp"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"originalTransactionId"</span>: <span class="hljs-string">"123456"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"$action"</span>: <span class="hljs-string">"INSERT"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"accountId"</span>: <span class="hljs-number">234</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"environment"</span>: <span class="hljs-string">"PROD"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"latestReceiptData"</span>: <span class="hljs-string">"bmd1aXNoZWQsIG5v"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"originalTransactionId"</span>: <span class="hljs-string">"234567"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>And it’s wholly equivalent here to use the unique index name instead of the column names for the conflict target, by using the <code>constraint</code> wrapper function:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  anotherNewTransaction: s.appleTransactions.Insertable = {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    environment: <span class="hljs-string">'PROD'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    originalTransactionId: <span class="hljs-string">'345678'</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    accountId: <span class="hljs-number">345</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    latestReceiptData: <span class="hljs-string">'lALvEleO4Ehwk3T5'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  result = <span class="hljs-keyword">await</span> db.upsert(<span class="hljs-string">'appleTransactions'</span>, anotherNewTransaction, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    db.constraint(<span class="hljs-string">'appleTransactionsPrimaryKey'</span>)).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"appleTransactions"</span> (<span class="hljs-string">"accountId"</span>, <span class="hljs-string">"environment"</span>, <span class="hljs-string">"latestReceiptData"</span>, <span class="hljs-string">"originalTransactionId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>, $<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">ON</span> CONFLICT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">CONSTRAINT</span> <span class="hljs-string">"appleTransactionsPrimaryKey"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">DO</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    (<span class="hljs-string">"accountId"</span>, <span class="hljs-string">"environment"</span>, <span class="hljs-string">"latestReceiptData"</span>, <span class="hljs-string">"originalTransactionId"</span>) = <span class="hljs-keyword">ROW</span> (EXCLUDED. <span class="hljs-string">"accountId"</span>, EXCLUDED. <span class="hljs-string">"environment"</span>, EXCLUDED. <span class="hljs-string">"latestReceiptData"</span>, EXCLUDED. <span class="hljs-string">"originalTransactionId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"appleTransactions"</span>.*) || jsonb_build_object(<span class="hljs-string">'$action'</span>, <span class="hljs-keyword">CASE</span> xmax</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">WHEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span></span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-string">'INSERT'</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">ELSE</span></span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-string">'UPDATE'</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">345</span>, <span class="hljs-string">"PROD"</span>, <span class="hljs-string">"lALvEleO4Ehwk3T5"</span>, <span class="hljs-string">"345678"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"$action"</span>: <span class="hljs-string">"INSERT"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"accountId"</span>: <span class="hljs-number">345</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"environment"</span>: <span class="hljs-string">"PROD"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"latestReceiptData"</span>: <span class="hljs-string">"lALvEleO4Ehwk3T5"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"originalTransactionId"</span>: <span class="hljs-string">"345678"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
</div>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/shortcuts.ts#L173">Source code »</a></div>
<h4 id="deletes"><code>deletes</code></h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> DeleteSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(table: T, where: WhereableForTable&lt;T&gt; | SQLFragment): SQLFragment&lt;JSONSelectableForTable&lt;T&gt;[]&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>The <code>deletes</code> shortcut, unsurprisingly, deletes rows from a table (<code>delete</code>, unfortunately, is a JavaScript reserved word). It takes the table name and an appropriate <code>Whereable</code> or <code>SQLFragment</code>, and returns the deleted rows as a <code>JSONSelectable</code>.</p>
<p>For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.deletes(<span class="hljs-string">'books'</span>, { title: <span class="hljs-string">'Holes'</span> }).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"title"</span> = $<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"Holes"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1004</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Holes"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.977396+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/shortcuts.ts#L193">Source code »</a></div>
<h4 id="truncate"><code>truncate</code></h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> TruncateIdentityOpts = <span class="hljs-string">'CONTINUE IDENTITY'</span> | <span class="hljs-string">'RESTART IDENTITY'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">type</span> TruncateForeignKeyOpts = <span class="hljs-string">'RESTRICT'</span> | <span class="hljs-string">'CASCADE'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">interface</span> TruncateSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  (table: Table | Table[], optId: TruncateIdentityOpts): SQLFragment&lt;<span class="hljs-literal">undefined</span>&gt;;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  (table: Table | Table[], optFK: TruncateForeignKeyOpts): SQLFragment&lt;<span class="hljs-literal">undefined</span>&gt;;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  (table: Table | Table[], optId: TruncateIdentityOpts, optFK: TruncateForeignKeyOpts): SQLFragment&lt;<span class="hljs-literal">undefined</span>&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>The <code>truncate</code> shortcut truncates one or more tables. It takes a <code>Table</code> name or a <code>Table[]</code> name array, and (optionally) the options <code>'CONTINUE IDENTITY'</code>/<code>'RESTART IDENTITY'</code> and/or <code>'RESTRICT'</code>/<code>'CASCADE'</code>.</p>
<p>For instance:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.truncate(<span class="hljs-string">'bankAccounts'</span>).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">TRUNCATE</span> <span class="hljs-string">"bankAccounts"</span></span></code></pre>
</div>
<p>One context in which this may be useful is in emptying a testing database at the start of each test run. Zapatos provides an <code>AllTables</code> type to help you ensure that you’ve listed all your tables:</p>
<pre class="language-typescript noresult runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> allTables: s.AllTables = [</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'appleTransactions'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'authors'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'bankAccounts'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'books'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'doctors'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'emailAuthentication'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'employees'</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'shifts'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'stores'</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-string">'tags'</span>,</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">];</span></code></pre>
<p>You can then empty the database like so:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-comment">// *** DON'T DO THIS IN PRODUCTION! ***</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.truncate(allTables, <span class="hljs-string">'CASCADE'</span>).run(pool);</span></code></pre>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/shortcuts.ts#L222">Source code »</a></div>
<h4 id="select-selectone-and-count"><code>select</code>, <code>selectOne</code> and <code>count</code></h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> SelectSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table, C <span class="hljs-keyword">extends</span> ColumnForTable&lt;T&gt;[], L <span class="hljs-keyword">extends</span> SQLFragmentsMap, E <span class="hljs-keyword">extends</span> SQLFragmentsMap, M <span class="hljs-keyword">extends</span> SelectResultMode = SelectResultMode.Many&gt; (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    table: T,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    where: WhereableForTable&lt;T&gt; | SQLFragment | AllType,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    options?: SelectOptionsForTable&lt;T, C, L, E&gt;,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    mode?: M,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ): SQLFragment&lt;FullSelectReturnTypeForTable&lt;T, C, L, E, M&gt;&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> SelectOneSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table, C <span class="hljs-keyword">extends</span> ColumnForTable&lt;T&gt;[], L <span class="hljs-keyword">extends</span> SQLFragmentsMap, E <span class="hljs-keyword">extends</span> SQLFragmentsMap&gt;(</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    table: T,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    where: WhereableForTable&lt;T&gt; | SQLFragment | AllType,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    options?: SelectOptionsForTable&lt;T, C, L, E&gt;,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ): SQLFragment&lt;FullSelectReturnTypeForTable&lt;T, C, L, E, SelectResultMode.One&gt;&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> CountSignatures {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  &lt;T <span class="hljs-keyword">extends</span> Table&gt;(</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    table: T, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    where: WhereableForTable&lt;T&gt; | SQLFragment | AllType, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    options?: { columns?: ColumnForTable&lt;T&gt;[], alias?: <span class="hljs-built_in">string</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ): SQLFragment&lt;<span class="hljs-built_in">number</span>&gt;;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>Yes, the signatures are beastly — and that’s leaving out the horrors behind <code>FullSelectReturnTypeForTable&lt;...&gt;</code> — but don’t panic!</p>
<p>The <code>select</code> shortcut function, in its basic form, takes a <code>Table</code> name and some <code>WHERE</code> conditions, and returns a <code>SQLFragment&lt;JSONSelectable[]&gt;</code>. Those <code>WHERE</code> conditions can be the symbol <code>all</code> (meaning: no conditions), the appropriate <code>Whereable</code> for the target table, or a <code>SQLFragment</code> from a <code>sql</code> template string. Recall that <a href="#whereable">a <code>Whereable</code> can itself contain <code>SQLFragment</code> values</a>, which means the <code>SQLFragment</code> variant is rarely required.</p>
<p>The <code>selectOne</code> function does the same except it gives us a <code>SQLFragment&lt;JSONSelectable&gt;</code>, promising only a single object when run. The <code>count</code> function, finally, generates a query to count matching rows, and thus returns a <code>SQLFragment&lt;number&gt;</code>.</p>
<p>In use, they look like this:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// select, no WHERE clause</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  allBooks = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, db.all).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// select, Whereable</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  authorBooks = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, { authorId: <span class="hljs-number">1000</span> }).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// selectOne (since authors.id is a primary key), Whereable</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  oneAuthor = <span class="hljs-keyword">await</span> db.selectOne(<span class="hljs-string">'authors'</span>, { id: <span class="hljs-number">1000</span> }).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// count</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  numberOfAuthors = <span class="hljs-keyword">await</span> db.count(<span class="hljs-string">'authors'</span>, db.all).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// select, Whereable with an embedded SQLFragment</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  recentAuthorBooks = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, { </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    authorId: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    createdAt: db.sql&lt;db.SQL&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;"><span class="hljs-string">      <span class="hljs-subst">${db.self}</span> &gt; now() - INTERVAL '7 days'`</span> </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }).run(pool),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// select, SQLFragment (but a Whereable might be preferable)</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  allRecentBooks = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, db.sql&lt;s.books.SQL&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;"><span class="hljs-string">    <span class="hljs-subst">${<span class="hljs-string">"createdAt"</span>}</span> &gt; now() - INTERVAL '7 days'`</span>).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"A Brief History of Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"authorId"</span> = $<span class="hljs-number">1</span>)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1000</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = $<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">2</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-number">8</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"authorId"</span> = $<span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">AND</span> (<span class="hljs-string">"createdAt"</span> &gt; <span class="hljs-keyword">now</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 days'</span>))) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1001</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">WHERE</span> <span class="hljs-string">"createdAt"</span> &gt; <span class="hljs-keyword">now</span>() - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 days'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"A Brief History of Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>Similar to our earlier shortcut examples, once I’ve typed in <code>'books'</code> or <code>'authors'</code> as the first argument to the function, TypeScript and VS Code know both how to type-check and auto-complete both the <code>WHERE</code> argument and the type that will returned by <code>run</code>.</p>
<p>The <code>select</code> and <code>selectOne</code> shortcuts can also take an <code>options</code> object as their third argument, which has these possible keys: <code>columns</code>, <code>order</code>, <code>limit</code>, <code>offset</code>, <code>extras</code>, <code>lateral</code> and <code>alias</code>.</p>
<h5 id="columns"><code>columns</code></h5>
<p>The <code>columns</code> key specifies that we want to return only a subset of columns, which we might do for reasons of efficiency. It takes an array of <code>Column</code> names for the appropriate table. For example:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> bookTitles = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, db.all, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { columns: [<span class="hljs-string">'title'</span>] }).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> jsonb_build_object($<span class="hljs-number">1</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"title"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"title"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"A Brief History of Time"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>The return type is appropriately narrowed to the requested columns only, so VS Code will complain if we now try to access <code>bookTitles[0].authorId</code>, for example.</p>
<h5 id="order-limit-and-offset"><code>order</code>, <code>limit</code> and <code>offset</code></h5>
<p>The <code>limit</code> and <code>offset</code> options each take a number and pass it directly through to SQL <code>LIMIT</code> and <code>OFFSET</code> clauses. The <code>order</code> option takes an <code>OrderSpecForTable[]</code>, which has this shape:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">interface</span> OrderSpecForTable&lt;T <span class="hljs-keyword">extends</span> Table&gt; {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  by: SQLForTable&lt;T&gt;;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  direction: <span class="hljs-string">'ASC'</span> | <span class="hljs-string">'DESC'</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  nulls?: <span class="hljs-string">'FIRST'</span> | <span class="hljs-string">'LAST'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>Putting them together gives us queries like this:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [lastButOneBook] = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, db.all, { </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  order: [{ by: <span class="hljs-string">'createdAt'</span>, direction: <span class="hljs-string">'DESC'</span> }], </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  limit: <span class="hljs-number">1</span>, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  offset: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">"createdAt"</span> <span class="hljs-keyword">DESC</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">1</span> <span class="hljs-keyword">OFFSET</span> $<span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>I used destructuring assignment here (<code>const [lastButOneBook] = /* ... */;</code>) to account for the fact that I know this query is only going to return one response. Unfortunately, destructuring is just syntactic sugar for indexing, and indexing in TypeScript <a href="https://github.com/Microsoft/TypeScript/issues/13778">doesn’t reflect that the result may be undefined</a>. That means that <code>lastButOneBook</code> is now typed as a <code>JSONSelectable</code>, but it could actually be <code>undefined</code>, and that could lead to errors down the line.</p>
<p>To work around this, we can use the <code>selectOne</code> function instead, which turns the example above into the following:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> lastButOneBook = <span class="hljs-keyword">await</span> db.selectOne(<span class="hljs-string">'books'</span>, db.all, {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  order: [{ by: <span class="hljs-string">'createdAt'</span>, direction: <span class="hljs-string">'DESC'</span> }], </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  offset: <span class="hljs-number">1</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">"createdAt"</span> <span class="hljs-keyword">DESC</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">1</span> <span class="hljs-keyword">OFFSET</span> $<span class="hljs-number">2</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
</div>
<p>The <code>{ limit: 1 }</code> option is now applied automatically. And the return type following <code>await</code> needs no destructuring and is now, correctly, <code>JSONSelectable | undefined</code>.</p>
<h5 id="lateral-and-alias"><code>lateral</code> and <code>alias</code></h5>
<p>Earlier we put together <a href="#manual-joins-using-postgres-json-features">some big <code>LATERAL</code> joins of authors and books</a>. This was a powerful and satisfying application of Postgres’ JSON support … but also a bit of an eyesore, heavy on both punctuation and manually constructed and applied types.</p>
<p>We can improve on this. Since <code>SQLFragments</code> are already designed to contain other <code>SQLFragments</code>, it’s a pretty small leap to enable <code>select</code>/<code>selectOne</code>/<code>count</code> calls to be nested inside other <code>select</code>/<code>selectOne</code> calls in order to significantly simplify this kind of <code>LATERAL</code> join query.</p>
<p>We achieve this with an additional <code>options</code> key, <code>lateral</code>, which takes a mapping of property names to nested query shortcuts. It allows us to write an even bigger join (of books, each with their author and tags) like so:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> booksAuthorTags = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'books'</span>, db.all, {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateral: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    author: db.selectOne(<span class="hljs-string">'authors'</span>, { id: db.parent(<span class="hljs-string">'authorId'</span>) }),</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    tags: db.select(<span class="hljs-string">'tags'</span>, { bookId: db.parent(<span class="hljs-string">'id'</span>) }),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) || jsonb_build_object($<span class="hljs-number">1</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_0"</span>.result, $<span class="hljs-number">2</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_1"</span>.result) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = <span class="hljs-string">"books"</span>.<span class="hljs-string">"authorId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">3</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_0"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"tags"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">FROM</span> <span class="hljs-string">"tags"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"bookId"</span> = <span class="hljs-string">"books"</span>.<span class="hljs-string">"id"</span>)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_tags"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_1"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"author"</span>, <span class="hljs-string">"tags"</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1000</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"1/3"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1000</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1001</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"2/3"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1001</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1002</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"3/3"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1002</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"mystery"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1003</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"physics"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"A Brief History of Time"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Stephen Hawking"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"physicist"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"autobiography"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"bookId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"author"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Stephen Hawking"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>Or we can turn this around, nesting more deeply to retrieve authors, each with their books, each with their tags:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> authorsBooksTags = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'authors'</span>, db.all, {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateral: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    books: db.select(<span class="hljs-string">'books'</span>, { authorId: db.parent(<span class="hljs-string">'id'</span>) }, {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      lateral: {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        tags: db.select(<span class="hljs-string">'tags'</span>, { bookId: db.parent(<span class="hljs-string">'id'</span>) }, { columns: [<span class="hljs-string">'tag'</span>] })</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    })</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"authors"</span>.*) || jsonb_build_object($<span class="hljs-number">1</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_0"</span>.result) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">SELECT</span> to_jsonb (<span class="hljs-string">"books"</span>.*) || jsonb_build_object($<span class="hljs-number">2</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_0"</span>.result) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">FROM</span> <span class="hljs-string">"books"</span></span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          <span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-keyword">SELECT</span> jsonb_build_object($<span class="hljs-number">3</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"tag"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-keyword">FROM</span> <span class="hljs-string">"tags"</span></span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"bookId"</span> = <span class="hljs-string">"books"</span>.<span class="hljs-string">"id"</span>)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_tags"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_0"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"authorId"</span> = <span class="hljs-string">"authors"</span>.<span class="hljs-string">"id"</span>)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_books"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_0"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_authors"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"books"</span>, <span class="hljs-string">"tags"</span>, <span class="hljs-string">"tag"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Philip Pullman"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          },</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"1/3"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          }</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        ],</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Northern Lights"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.970665+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          },</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"2/3"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          }</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        ],</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Subtle Knife"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.971987+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"His Dark Materials"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          },</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"3/3"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          }</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        ],</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Amber Spyglass"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1000</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.972453+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mark Haddon"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1003</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"mystery"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          }</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        ],</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"The Curious Incident of the Dog in the Night-Time"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">1001</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:52:59.976416+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1002</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Louis Sachar"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Gabriel Garcia Marquez"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Douglas Adams"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Jane Austen"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">4</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Joseph Conrad"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Stephen Hawking"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"books"</span>: [</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"physics"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          }</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        ],</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"A Brief History of Time"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      {</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"tags"</span>: [</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"physicist"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          },</span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          {</span>
<span class="indent-line" style="padding-left: 16ch; text-indent: -16ch;">            <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"autobiography"</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;">          }</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        ],</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"title"</span>: <span class="hljs-string">"My Brief History"</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"authorId"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        <span class="hljs-attr">"createdAt"</span>: <span class="hljs-string">"2020-05-28T13:53:09.58378+01:00"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    ],</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"isLiving"</span>: <span class="hljs-literal">false</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>You’ll note the use of the <code>parent</code> function to refer to a join column in the table of the containing query. This is simply a convenience: in the join of books to authors above, we could just as well formulate the <code>Whereable</code> as:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{ authorId: sql<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-string">"authors"</span>}</span>.<span class="hljs-subst">${<span class="hljs-string">"id"</span>}</span>`</span> }</span></code></pre>
<p>We can also nest <code>count</code> and <code>selectOne</code> calls, as you might expect. And we can join a table to itself, though in this case we <em>must</em> remember to use the <code>alias</code> option to define an alternative table name, resolving ambiguity:</p>
<p>Take this new, self-referencing table:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"employees"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"id"</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"name"</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"managerId"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">"employees"</span>(<span class="hljs-string">"id"</span>) );</span></code></pre>
<p>Add some employees:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  anna = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'employees'</span>, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { name: <span class="hljs-string">'Anna'</span> }).run(pool),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  [beth, charlie] = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'employees'</span>, [</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { name: <span class="hljs-string">'Beth'</span>, managerId: anna.id },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { name: <span class="hljs-string">'Charlie'</span>, managerId: anna.id },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ]).run(pool),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  dougal = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'employees'</span>, </span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    { name: <span class="hljs-string">'Dougal'</span>, managerId: beth.id }).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"employees"</span> (<span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"employees"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"Anna"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Anna"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"managerId"</span>: <span class="hljs-literal">null</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"employees"</span> (<span class="hljs-string">"managerId"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>), ($<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"employees"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1</span>, <span class="hljs-string">"Beth"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"Charlie"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Beth"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"managerId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Charlie"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"managerId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"employees"</span> (<span class="hljs-string">"managerId"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"employees"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">2</span>, <span class="hljs-string">"Dougal"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"id"</span>: <span class="hljs-number">4</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Dougal"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"managerId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
</div>
<p>Then query for a summary (joining the table to itself twice, with appropriate aliasing):</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> people = <span class="hljs-keyword">await</span> db.select(<span class="hljs-string">'employees'</span>, db.all, {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  columns: [<span class="hljs-string">'name'</span>], </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateral: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    lineManager: db.selectOne(<span class="hljs-string">'employees'</span>, { id: db.parent(<span class="hljs-string">'managerId'</span>) },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      { alias: <span class="hljs-string">'managers'</span>, columns: [<span class="hljs-string">'name'</span>] }),</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    directReports: db.count(<span class="hljs-string">'employees'</span>, { managerId: db.parent(<span class="hljs-string">'id'</span>) },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      { alias: <span class="hljs-string">'reports'</span> }),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">SELECT</span> jsonb_build_object($<span class="hljs-number">1</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"name"</span>) || jsonb_build_object($<span class="hljs-number">2</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_0"</span>.result, $<span class="hljs-number">3</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_1"</span>.result) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">FROM</span> <span class="hljs-string">"employees"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> jsonb_build_object($<span class="hljs-number">4</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"name"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> <span class="hljs-string">"employees"</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">"managers"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = <span class="hljs-string">"employees"</span>.<span class="hljs-string">"managerId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">5</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_0"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-string">"reports"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> <span class="hljs-string">"employees"</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">"reports"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"managerId"</span> = <span class="hljs-string">"employees"</span>.<span class="hljs-string">"id"</span>)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_1"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_employees"</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"name"</span>, <span class="hljs-string">"lineManager"</span>, <span class="hljs-string">"directReports"</span>, <span class="hljs-string">"name"</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Anna"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"lineManager"</span>: <span class="hljs-literal">null</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"directReports"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Beth"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"lineManager"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Anna"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"directReports"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Charlie"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"lineManager"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Anna"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"directReports"</span>: <span class="hljs-number">0</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Dougal"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"lineManager"</span>: {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Beth"</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"directReports"</span>: <span class="hljs-number">0</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>As usual, this is fully typed. If, for example, you were to forget that <code>directReports</code> is a count rather than an array of employees, VS Code would soon disabuse you.</p>
<p>There are still a couple of limitations to type inference for nested queries. First, there’s no check that your join makes sense (column types and <code>REFERENCES</code> relationships are not exploited in the <code>Whereable</code> term). Second, the result type of a nested <code>selectOne</code> always includes <code>undefined</code> even if the relevant foreign key is <code>NOT NULL</code> and has a <code>REFERENCES</code> constraint (in which case we know that Postgres will have enforced the existence of a record).</p>
<p>Nevertheless, this is a handy, flexible — but still transparent and zero-abstraction — way to generate and run complex join queries.</p>
<h5 id="extras"><code>extras</code></h5>
<p>The <code>extras</code> option allows us to include additional result keys that don’t represent columns of our tables. That could be a computed quantity, such as a geographical distance via <a href="https://postgis.net/">PostGIS</a>.</p>
<p>The option takes a mapping of property names to <code>sql</code> template strings (i.e. <code>SQLFragments</code>). The <code>RunResult</code> type variables of those template strings are significant, as they are passed through to the result type.</p>
<p>Let’s see <code>extras</code> in use, with an example that shows too how the <code>lateral</code> option can go well beyond simply matching a foreign key to a primary key.</p>
<p>Take this new table:</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> EXTENSION postgis;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"stores"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"id"</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"name"</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"geom"</span> GEOMETRY <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> );</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-string">"storesGeomIdx"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"stores"</span> <span class="hljs-keyword">USING</span> gist(<span class="hljs-string">"geom"</span>);</span></code></pre>
<p>Insert some new stores:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> gbPoint = <span class="hljs-function">(<span class="hljs-params">mEast: <span class="hljs-built_in">number</span>, mNorth: <span class="hljs-built_in">number</span></span>) =&gt;</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  db.sql<span class="hljs-string">`ST_SetSRID(ST_Point(<span class="hljs-subst">${db.param(mEast)}</span>, <span class="hljs-subst">${db.param(mNorth)}</span>), 27700)`</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [brighton] = <span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'stores'</span>, [</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Brighton'</span>, geom: gbPoint(<span class="hljs-number">530590</span>, <span class="hljs-number">104190</span>) },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'London'</span>, geom: gbPoint(<span class="hljs-number">534930</span>, <span class="hljs-number">179380</span>) },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Edinburgh'</span>, geom: gbPoint(<span class="hljs-number">323430</span>, <span class="hljs-number">676130</span>) },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Newcastle'</span>, geom: gbPoint(<span class="hljs-number">421430</span>, <span class="hljs-number">563130</span>) },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { name: <span class="hljs-string">'Exeter'</span>, geom: gbPoint(<span class="hljs-number">288430</span>, <span class="hljs-number">92130</span>) },</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"stores"</span> (<span class="hljs-string">"geom"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> (ST_SetSRID (ST_Point ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>), <span class="hljs-number">27700</span>), $<span class="hljs-number">3</span>), (ST_SetSRID (ST_Point ($<span class="hljs-number">4</span>, $<span class="hljs-number">5</span>), <span class="hljs-number">27700</span>), $<span class="hljs-number">6</span>), (ST_SetSRID (ST_Point ($<span class="hljs-number">7</span>, $<span class="hljs-number">8</span>), <span class="hljs-number">27700</span>), $<span class="hljs-number">9</span>), (ST_SetSRID (ST_Point ($<span class="hljs-number">10</span>, $<span class="hljs-number">11</span>), <span class="hljs-number">27700</span>), $<span class="hljs-number">12</span>), (ST_SetSRID (ST_Point ($<span class="hljs-number">13</span>, $<span class="hljs-number">14</span>), <span class="hljs-number">27700</span>), $<span class="hljs-number">15</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"stores"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">530590</span>, <span class="hljs-number">104190</span>, <span class="hljs-string">"Brighton"</span>, <span class="hljs-number">534930</span>, <span class="hljs-number">179380</span>, <span class="hljs-string">"London"</span>, <span class="hljs-number">323430</span>, <span class="hljs-number">676130</span>, <span class="hljs-string">"Edinburgh"</span>, <span class="hljs-number">421430</span>, <span class="hljs-number">563130</span>, <span class="hljs-string">"Newcastle"</span>, <span class="hljs-number">288430</span>, <span class="hljs-number">92130</span>, <span class="hljs-string">"Exeter"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"geom"</span>: <span class="hljs-string">"0101000020346C0000000000003C31204100000000E06FF940"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Brighton"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"geom"</span>: <span class="hljs-string">"0101000020346C0000000000002453204100000000A0E50541"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"London"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"geom"</span>: <span class="hljs-string">"0101000020346C00000000000098BD13410000000044A22441"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Edinburgh"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">4</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"geom"</span>: <span class="hljs-string">"0101000020346C000000000000D8B8194100000000742F2141"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Newcastle"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"geom"</span>: <span class="hljs-string">"0101000020346C000000000000B89A114100000000207EF640"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Exeter"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>And now query my local store (Brighton) plus its three nearest alternatives, with their distances in metres, using PostGIS’s index-aware <a href="https://postgis.net/docs/geometry_distance_knn.html"><code>&lt;-&gt; operator</code></a>:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> s <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/schema'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> localStore = <span class="hljs-keyword">await</span> db.selectOne(<span class="hljs-string">'stores'</span>, { id: <span class="hljs-number">1</span> }, {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  columns: [<span class="hljs-string">'name'</span>],</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  lateral: {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    alternatives: db.select(<span class="hljs-string">'stores'</span>, db.sql<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-string">"id"</span>}</span> &lt;&gt; <span class="hljs-subst">${db.parent(<span class="hljs-string">"id"</span>)}</span>`</span>, {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      alias: <span class="hljs-string">'nearby'</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      columns: [<span class="hljs-string">'name'</span>],</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      extras: {  <span class="hljs-comment">// &lt;-- here it is!</span></span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        distance: db.sql&lt;s.stores.SQL, <span class="hljs-built_in">number</span>&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;"><span class="hljs-string">          <span class="hljs-subst">${<span class="hljs-string">"geom"</span>}</span> &lt;-&gt; <span class="hljs-subst">${db.parent(<span class="hljs-string">"geom"</span>)}</span>`</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      },</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      order: [{ </span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        by: db.sql&lt;s.stores.SQL&gt;<span class="hljs-string">`</span></span>
<span class="indent-line" style="padding-left: 14ch; text-indent: -14ch;"><span class="hljs-string">          <span class="hljs-subst">${<span class="hljs-string">"geom"</span>}</span> &lt;-&gt; <span class="hljs-subst">${db.parent(<span class="hljs-string">"geom"</span>)}</span>`</span>, </span>
<span class="indent-line" style="padding-left: 12ch; text-indent: -12ch;">        direction: <span class="hljs-string">'ASC'</span> </span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      }],</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      limit: <span class="hljs-number">3</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    })</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> jsonb_build_object($<span class="hljs-number">1</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"name"</span>) || jsonb_build_object($<span class="hljs-number">2</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"ljoin_0"</span>.result) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"stores"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">coalesce</span>(jsonb_agg(<span class="hljs-keyword">result</span>), <span class="hljs-string">'[]'</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">FROM</span> (</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">SELECT</span> jsonb_build_object($<span class="hljs-number">3</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"name"</span>) || jsonb_build_object($<span class="hljs-number">4</span>::<span class="hljs-built_in">text</span>, <span class="hljs-string">"geom"</span> &lt;-&gt; <span class="hljs-string">"stores"</span>.<span class="hljs-string">"geom"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">FROM</span> <span class="hljs-string">"stores"</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">"nearby"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">WHERE</span> <span class="hljs-string">"id"</span> &lt;&gt; <span class="hljs-string">"stores"</span>.<span class="hljs-string">"id"</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">"geom"</span> &lt;-&gt; <span class="hljs-string">"stores"</span>.<span class="hljs-string">"geom"</span> <span class="hljs-keyword">ASC</span></span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">5</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"sq_nearby"</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"ljoin_0"</span> <span class="hljs-keyword">ON</span> <span class="hljs-literal">true</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"id"</span> = $<span class="hljs-number">6</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">LIMIT</span> $<span class="hljs-number">7</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"name"</span>, <span class="hljs-string">"alternatives"</span>, <span class="hljs-string">"name"</span>, <span class="hljs-string">"distance"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">{</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Brighton"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-attr">"alternatives"</span>: [</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"London"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"distance"</span>: <span class="hljs-number">75315.1492065175</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Exeter"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"distance"</span>: <span class="hljs-number">242460.11878245</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    },</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Newcastle"</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      <span class="hljs-attr">"distance"</span>: <span class="hljs-number">471743.393382462</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ]</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
</div>
<div style="height: 1px; clear: both;"></div><div class="src-link"><a href="https://github.com/jawj/zapatos/blob/master/src/transaction.ts#L53">Source code »</a></div>
<h3 id="transaction"><code>transaction</code></h3>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> Isolation {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// these are the only meaningful values in Postgres: </span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// see https://www.postgresql.org/docs/11/sql-set-transaction.html</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  Serializable = <span class="hljs-string">"SERIALIZABLE"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  RepeatableRead = <span class="hljs-string">"REPEATABLE READ"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ReadCommitted = <span class="hljs-string">"READ COMMITTED"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  SerializableRO = <span class="hljs-string">"SERIALIZABLE, READ ONLY"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  RepeatableReadRO = <span class="hljs-string">"REPEATABLE READ, READ ONLY"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  ReadCommittedRO = <span class="hljs-string">"READ COMMITTED, READ ONLY"</span>,</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  SerializableRODeferrable = <span class="hljs-string">"SERIALIZABLE, READ ONLY, DEFERRABLE"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transaction</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">M</span> <span class="hljs-title">extends</span> <span class="hljs-title">Isolation</span>&gt;(<span class="hljs-params"></span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-function"><span class="hljs-params">  pool: pg.Pool,</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-function"><span class="hljs-params">  isolationMode: M,</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-function"><span class="hljs-params">  callback: (client: TxnClient&lt;M&gt;) =&gt; <span class="hljs-built_in">Promise</span>&lt;T&gt;</span></span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-function"><span class="hljs-params"></span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">T</span>&gt;</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-function"></span></span></code></pre>
<p>The <code>transaction</code> helper takes a <code>pg.Pool</code> instance, an isolation mode, and an <code>async</code> callback function. It then proceeds as follows:</p>
<ul>
<li>Issue a <code>BEGIN TRANSACTION</code>.</li>
<li>Call the callback, passing to it a database client to use in place of a <code>pg.Pool</code>.</li>
<li>If a serialization error is thrown, try again after a <a href="#run-time-configuration">configurable</a> random delay, a <a href="#run-time-configuration">configurable</a> number of times.</li>
<li>If any other error is thrown, issue a <code>ROLLBACK</code>, release the database client, and re-throw the error.</li>
<li>Otherwise <code>COMMIT</code> the transaction, release the database client, and return the callback’s result.</li>
</ul>
<p>As is implied above, for <code>REPEATABLE READ</code> or <code>SYNCHRONIZED</code> isolation modes the callback could be called several times. It’s therefore important that it doesn’t have any non-database-related side-effects (i.e. don’t, say, bill your customer’s credit card from this function).</p>
<p>We already saw <a href="#transactions">one <code>transaction</code> example</a>. Here’s another, adapted from <a href="https://www.cockroachlabs.com/docs/stable/demo-serializable.html">CockroachDB’s write-up on <code>SERIALIZABLE</code></a>.</p>
<p>We have a table of <code>doctors</code>, and one of their assigned <code>shifts</code>.</p>
<pre class="language-sql"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"doctors"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"id"</span> <span class="hljs-built_in">SERIAL</span> PRIMARY <span class="hljs-keyword">KEY</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"name"</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> );</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"shifts"</span> </span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">( <span class="hljs-string">"day"</span> <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, <span class="hljs-string">"doctorId"</span> <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">"doctors"</span>(<span class="hljs-string">"id"</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">, PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">"day"</span>, <span class="hljs-string">"doctorId"</span>) );</span></code></pre>
<p>We populate those tables with two doctors and two days’ shifts:</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'doctors'</span>, [</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Annabel'</span> }, </span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { id: <span class="hljs-number">2</span>, name: <span class="hljs-string">'Brian'</span> },</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]).run(pool);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">await</span> db.insert(<span class="hljs-string">'shifts'</span>, [</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { day: <span class="hljs-string">'2020-12-24'</span>, doctorId: <span class="hljs-number">1</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { day: <span class="hljs-string">'2020-12-24'</span>, doctorId: <span class="hljs-number">2</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { day: <span class="hljs-string">'2020-12-25'</span>, doctorId: <span class="hljs-number">1</span> },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  { day: <span class="hljs-string">'2020-12-25'</span>, doctorId: <span class="hljs-number">2</span> },</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]).run(pool);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"doctors"</span> (<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>), ($<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"doctors"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-number">1</span>, <span class="hljs-string">"Annabel"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"Brian"</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Annabel"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"id"</span>: <span class="hljs-number">2</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Brian"</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"shifts"</span> (<span class="hljs-string">"day"</span>, <span class="hljs-string">"doctorId"</span>)</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>), ($<span class="hljs-number">3</span>, $<span class="hljs-number">4</span>), ($<span class="hljs-number">5</span>, $<span class="hljs-number">6</span>), ($<span class="hljs-number">7</span>, $<span class="hljs-number">8</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"shifts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"2020-12-24"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"2020-12-24"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">2</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"day"</span>: <span class="hljs-string">"2020-12-24"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"doctorId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"day"</span>: <span class="hljs-string">"2020-12-24"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"doctorId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"day"</span>: <span class="hljs-string">"2020-12-25"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"doctorId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  },</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"day"</span>: <span class="hljs-string">"2020-12-25"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"doctorId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
</div>
<p>The important business logic is that there must always be <em>at least one doctor</em> on shift. Now let’s say both doctors happen at the same moment to request leave for 25 December.</p>
<pre class="language-typescript runnable"><code class="imports"><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'./zapatos/src'</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">import</span> pool <span class="hljs-keyword">from</span> <span class="hljs-string">'./pgPool'</span>;</span></code><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> requestLeaveForDoctorOnDay = <span class="hljs-keyword">async</span> (doctorId: <span class="hljs-built_in">number</span>, day: <span class="hljs-built_in">string</span>) =&gt;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  db.transaction(pool, db.Isolation.Serializable, <span class="hljs-keyword">async</span> txnClient =&gt; {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">const</span> otherDoctorsOnShift = <span class="hljs-keyword">await</span> db.count(<span class="hljs-string">'shifts'</span>, {</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      doctorId: db.sql&lt;db.SQL&gt;<span class="hljs-string">`<span class="hljs-subst">${db.self}</span> != <span class="hljs-subst">${db.param(doctorId)}</span>`</span>,</span>
<span class="indent-line" style="padding-left: 10ch; text-indent: -10ch;">      day,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    }).run(txnClient);</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">if</span> (otherDoctorsOnShift === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">await</span> db.deletes(<span class="hljs-string">'shifts'</span>, { day, doctorId }).run(txnClient);</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  });</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">const</span> [leaveBookedForAnnabel, leaveBookedForBrian] = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all([</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-comment">// in practice, these requests would come from different front-ends</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  requestLeaveForDoctorOnDay(<span class="hljs-number">1</span>, <span class="hljs-string">'2020-12-25'</span>),</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  requestLeaveForDoctorOnDay(<span class="hljs-number">2</span>, <span class="hljs-string">'2020-12-25'</span>),</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]);</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Leave booked for:</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  Annabel – <span class="hljs-subst">${leaveBookedForAnnabel}</span></span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;"><span class="hljs-string">  Brian – <span class="hljs-subst">${leaveBookedForBrian}</span>`</span>);</span></code></pre><div class="sqlstuff">
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-string">"shifts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"shifts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"day"</span> = $<span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">AND</span> (<span class="hljs-string">"doctorId"</span> != $<span class="hljs-number">2</span>))</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">2</span>]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-string">"shifts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"shifts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"day"</span> = $<span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">AND</span> (<span class="hljs-string">"doctorId"</span> != $<span class="hljs-number">2</span>))</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-number">1</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">"shifts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"day"</span> = $<span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">AND</span> <span class="hljs-string">"doctorId"</span> = $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"shifts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">2</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-number">1</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">"shifts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"day"</span> = $<span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-keyword">AND</span> <span class="hljs-string">"doctorId"</span> = $<span class="hljs-number">2</span>)</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">RETURNING</span> to_jsonb (<span class="hljs-string">"shifts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"day"</span>: <span class="hljs-string">"2020-12-25"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"doctorId"</span>: <span class="hljs-number">2</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">COMMIT</span></span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  {</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"day"</span>: <span class="hljs-string">"2020-12-25"</span>,</span>
<span class="indent-line" style="padding-left: 8ch; text-indent: -8ch;">    <span class="hljs-attr">"doctorId"</span>: <span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  }</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">]</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">COMMIT</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">ROLLBACK</span></span></code></pre>
<pre class="transactionlog"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">Transaction #0 rollback (code 40001) on attempt 1 of 5, retrying in 210ms</span></code></pre>
<pre class="transactionlog"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">Retrying transaction #0, attempt 2 of 5</span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">START</span> <span class="hljs-keyword">TRANSACTION</span> <span class="hljs-keyword">ISOLATION</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SERIALIZABLE</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-string">"shifts"</span>.*) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">result</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">FROM</span> <span class="hljs-string">"shifts"</span></span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">WHERE</span> (<span class="hljs-string">"day"</span> = $<span class="hljs-number">1</span></span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">AND</span> (<span class="hljs-string">"doctorId"</span> != $<span class="hljs-number">2</span>))</span></code></pre>
<pre class="sqlvalues"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">[<span class="hljs-string">"2020-12-25"</span>, <span class="hljs-number">1</span>]</span></code></pre>
<pre class="sqlresult"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-number">0</span></span></code></pre>
<pre class="sqltext"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">COMMIT</span></span></code></pre>
<pre class="console"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">Leave booked for:</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  Annabel – false</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  Brian – true</span></code></pre>
</div>
<p>Expanding the results, we see that one of the requests is retried and then fails — as it must to retain one doctor on shift — thanks to the <code>SERIALIZABLE</code> isolation (<code>REPEATABLE READ</code>, which is one isolation level weaker, wouldn’t help).</p>
<h4 id="txnsatisfying-types"><code>TxnSatisfying</code> types</h4>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> TxnSatisfying {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> Serializable = Isolation.Serializable;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> RepeatableRead = Serializable | Isolation.RepeatableRead;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> ReadCommitted = RepeatableRead | Isolation.ReadCommitted;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> SerializableRO = Serializable | Isolation.SerializableRO;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> RepeatableReadRO = SerializableRO | RepeatableRead | Isolation.RepeatableReadRO;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> ReadCommittedRO = RepeatableReadRO | ReadCommitted | Isolation.ReadCommittedRO;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> SerializableRODeferrable = SerializableRO | Isolation.SerializableRODeferrable;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">}</span></code></pre>
<p>If you find yourself passing transaction clients around, you may find the <code>TxnSatisfying</code> types useful. For example, if you type a <code>txnClient</code> argument to a function as <code>TxnSatisfying.RepeatableRead</code>, you can call it with <code>Isolation.Serializable</code> or <code>Isolation.RepeatableRead</code> but not <code>Isolation.ReadCommitted</code>.</p>
<h3 id="run-time-configuration">Run-time configuration</h3>
<p>There are a few configuration options you can set at runtime:</p>
<pre class="language-typescript norun"><code><span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> Config {</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  transactionAttemptsMax: <span class="hljs-built_in">number</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  transactionRetryDelay: { minMs: <span class="hljs-built_in">number</span>, maxMs: <span class="hljs-built_in">number</span> };</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  queryListener?(str: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  resultListener?(str: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span>;</span>
<span class="indent-line" style="padding-left: 6ch; text-indent: -6ch;">  transactionListener?(str: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span>;</span>
<span class="indent-line" style="padding-left: 4ch; text-indent: -4ch;">};</span></code></pre>
<p>Read the current values with <code>getConfig()</code> and set new values with <code>setConfig(newConfig: Partial&lt;Config&gt;)</code>.</p>
<ul>
<li>
<p><code>transactionAttemptsMax</code> determines how many times the <code>transaction</code> helper will try to execute a query in the face of serialization errors before giving up. It defaults to <code>5</code>.</p>
</li>
<li>
<p><code>transactionRetryDelay</code> determines the range within which the <code>transaction</code> helper will pick a random delay before each retry. It’s expressed in milliseconds and defaults to <code>{ minMs: 25, maxMs: 250 }</code>.</p>
</li>
<li>
<p><code>queryListener</code> and <code>resultListener</code>, if set, are called from the <code>run</code> function, and receive the results of (respectively) compiling and then executing and transforming each query.</p>
</li>
<li>
<p><code>transactionListener</code>, similarly, is called with messages about transaction retries.</p>
</li>
</ul>
<p>You might use one or more of the three listener functions to implement logging. They’re also used in generating the <em>Show generated SQL, results</em> elements of this documentation.</p>
<h2 id="about-zapatos">About Zapatos</h2>
<h3 id="alternatives">Alternatives</h3>
<p>If you’re interested in Zapatos, you might also want to consider <a href="https://www.prisma.io/">Prisma</a>, <a href="https://github.com/Ff00ff/mammoth">Mammoth</a>, and <a href="https://github.com/adelsz/pgtyped">PgTyped</a>.</p>
<h3 id="this-documentation">This documentation</h3>
<p>This document is generated from a <a href="https://github.com/jawj/zapatos-docs/">separate repository</a>. All generated SQL has been funnelled through <a href="https://github.com/darold/pgFormatter">pgFormatter</a> for easier reading.</p>
<h3 id="fixes-feature-and-contributions">Fixes, feature and contributions</h3>
<p>If you’re asking for or contributing new work, my response is likely to reflect these principles:</p>
<p><strong>Correct, consistent, comprehensible.</strong>  I’m pretty likely to accept pull requests that fix bugs or improve readability or consistency without any major trade-offs. I’ll also do my best to act on clear, minimal test cases that demonstrate unambiguous bugs.</p>
<p><strong>Small is beautiful.</strong>  I’m less likely to accept pull requests for features that significantly complicate the code base either to address niche use-cases or to eke out minor performance gains that are almost certainly swamped by network and database latencies.</p>
<p><strong>Scratching my own itch.</strong>  I’m unlikely to put a lot of my own effort into features I don’t currently need …&nbsp;unless we’re talking about paid consultancy, which I’m more than happy to discuss.</p>
<h3 id="whats-next">What’s next</h3>
<p>Some nice-to-haves would include:</p>
<ul>
<li>
<p><strong>More complete typing of <code>lateral</code> queries.</strong>  It would be great to make use of foreign key relationships and suchlike in generated types and the shortcut functions that make use of them.</p>
</li>
<li>
<p><strong>Tests.</strong>  The proprietary server API that’s the original consumer of this library, over at <a href="http://www.psyt.co.uk">Psychological Technologies</a>, has a test suite that exercises most of the code base at least a little. Nevertheless, a proper test suite is still kind of indispensable. It should test not just returned values but also inferred types — which is a little fiddly.</p>
</li>
</ul>
<h3 id="licence">Licence</h3>
<p>This software is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT licence</a>.</p>
<p>Copyright © 2020 George MacKerron</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<p><a href="https://translate.google.com/#view=home&amp;op=translate&amp;sl=es&amp;tl=en&amp;text=zapatos"><img src="zapatos.jpg" width="175" alt="Zapatos = shoes" style="margin-top: 60px; border: none;"></a></p>
</div>
        <script src="docs.js"></script>
      
    
  </body></html>